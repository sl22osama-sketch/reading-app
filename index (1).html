<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>برنامج تسجيل القراءة التفاعلي</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Arabic:wght@400;500;600;700;800&family=Cairo:wght@400;600;700;800&display=swap");

    * { box-sizing: border-box; }
    body {
      font-family: "Noto Sans Arabic", "Amiri", "Cairo", sans-serif;
      background: linear-gradient(135deg, #e0f2fe 0%, #f3e5f5 50%, #fce4ec 100%);
      min-height: 100vh; position: relative; overflow-x: hidden;
    }
    body::before {
      content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background:
        radial-gradient(circle at 20% 80%, rgba(33,150,243,.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(156,39,176,.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(103,58,183,.25) 0%, transparent 50%),
        radial-gradient(circle at 60% 60%, rgba(255,193,7,.2) 0%, transparent 50%);
      pointer-events: none; z-index: -1;
    }
    .glass-card { background: rgba(255,255,255,.85); backdrop-filter: blur(15px); border: 2px solid rgba(255,255,255,.9); box-shadow: 0 12px 40px rgba(0,0,0,.15); }
    .glass-card-dark { background: rgba(255,255,255,.75); backdrop-filter: blur(20px); border: 2px solid rgba(255,255,255,.8); box-shadow: 0 8px 32px rgba(0,0,0,.1); }
    .reading-text { line-height: 3; font-size: 1.5rem; font-weight: 600; color: #1a202c; text-shadow: 0 1px 2px rgba(0,0,0,.05); letter-spacing: .5px; word-spacing: 4px; font-family: "Noto Sans Arabic", "Amiri", serif; }
    .timer-circle { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; filter: drop-shadow(0 0 8px rgba(59,130,246,.5)); }
    .timer-container { background: linear-gradient(145deg, rgba(255,255,255,.3), rgba(255,255,255,.1)); backdrop-filter: blur(20px); border: 2px solid rgba(255,255,255,.3); box-shadow: 0 8px 32px rgba(0,0,0,.1), inset 0 1px 0 rgba(255,255,255,.4); }
    .btn-gradient { background: linear-gradient(145deg, #1976d2, #7b1fa2); border: none; position: relative; overflow: hidden; transition: all .3s ease; box-shadow: 0 6px 20px rgba(25,118,210,.4); font-weight: 600; }
    .btn-gradient:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(25,118,210,.6); }
    .btn-gradient::before { content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent); transition: left .5s; }
    .btn-gradient:hover::before { left: 100%; }
    .btn-success { background: linear-gradient(145deg, #10b981, #059669); box-shadow: 0 4px 15px rgba(16,185,129,.4); }
    .btn-success:hover { box-shadow: 0 8px 25px rgba(16,185,129,.6); }
    .btn-warning { background: linear-gradient(145deg, #f59e0b, #d97706); box-shadow: 0 4px 15px rgba(245,158,11,.4); }
    .btn-warning:hover { box-shadow: 0 8px 25px rgba(245,158,11,.6); }
    .btn-danger { background: linear-gradient(145deg, #ef4444, #dc2626); box-shadow: 0 4px 15px rgba(239,68,68,.4); }
    .btn-danger:hover { box-shadow: 0 8px 25px rgba(239,68,68,.6); }
    .progress-bar { background: linear-gradient(90deg, #10b981, #059669); transition: width .3s ease; box-shadow: 0 2px 10px rgba(16,185,129,.3); }
    .stats-card { background: linear-gradient(145deg, rgba(255,255,255,.9), rgba(255,255,255,.7)); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.8); transition: all .3s ease; }
    .stats-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,.1); }
    .word-highlight { background: linear-gradient(120deg, #fef3c7, #fde68a); padding: 4px 8px; border-radius: 8px; border: 2px solid #f59e0b; font-weight: 700; font-size: 1.1em; animation: pulse 2s infinite; box-shadow: 0 2px 8px rgba(245,158,11,.3); }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }
    .celebration { animation: celebrate .6s ease-in-out; }
    @keyframes celebrate { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }
    .floating-icon { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    .recording-pulse { animation: recordingPulse 1.5s ease-in-out infinite; }
    @keyframes recordingPulse { 0%,100%{ background: linear-gradient(145deg,#ef4444,#dc2626); box-shadow:0 4px 15px rgba(239,68,68,.4);} 50%{ background: linear-gradient(145deg,#f87171,#ef4444); box-shadow:0 8px 25px rgba(239,68,68,.8);} }
    .recording-indicator { display:inline-block; width:12px; height:12px; background:#ef4444; border-radius:50%; animation: blink 1s infinite; margin-left:8px; }
    @keyframes blink { 0%,50%{opacity:1} 51%,100%{opacity:.3} }
  </style>
</head>
<body class="p-4">
  <!-- نظام الإشعارات -->
  <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- ADDED: عنصر صوت احتياطي لتشغيل ملفات MP3 المحلية عند عدم توفر أصوات النظام -->
  <audio id="fallbackAudio" preload="auto"></audio>

  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">📚 برنامج تسجيل القراءة التفاعلي</h1>
      <p class="text-lg text-gray-600 font-medium">طور مهاراتك في القراءة مع التوقيت والإحصائيات المفصلة</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Reading Area -->
      <div class="lg:col-span-2">
        <div class="glass-card rounded-2xl p-6 mb-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center"><span class="floating-icon">📖</span><span class="mr-3">نص القراءة</span></h2>
            <div class="flex gap-2">
              <button onclick="changeTextSize('increase')" class="btn-gradient text-white px-4 py-2 rounded-lg text-sm">أ+</button>
              <button onclick="changeTextSize('decrease')" class="btn-gradient text-white px-4 py-2 rounded-lg text-sm">أ-</button>
            </div>
          </div>

          <div class="mb-4">
            <select id="textSelect" onchange="loadSelectedText()" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none font-medium">
              <option value="0">النص الأول - التَّكْنُولُوجِيَا فِي حَيَاتِنَا</option>
              <option value="1">النص الثاني - حِمَايَةُ الْبِيئَةِ مَسْؤُولِيَّتُنَا</option>
              <option value="2">النص الثالث - أَهَمِّيَّةُ الْقِرَاءَةِ وَالْمُطَالَعَةِ</option>
            </select>
          </div>

          <div id="readingText" class="reading-text p-8 bg-gradient-to-br from-white to-blue-50 rounded-xl border-2 border-blue-200 min-h-[350px] shadow-inner"></div>
        </div>

        <!-- Controls -->
        <div class="glass-card rounded-2xl p-6">
          <div class="mb-4">
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center"><span class="floating-icon">🎮</span><span class="mr-2">أدوات التحكم</span></h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <button id="startBtn" onclick="startReading()" class="btn-success text-white px-6 py-3 rounded-xl font-bold text-lg">🎯 ابدأ القراءة</button>
              <button id="pauseBtn" onclick="pauseReading()" class="btn-warning text-white px-6 py-3 rounded-xl font-bold text-lg" disabled>⏸️ توقف</button>
              <button id="stopBtn" onclick="stopReading()" class="btn-danger text-white px-6 py-3 rounded-xl font-bold text-lg" disabled>⏹️ إنهاء</button>
              <button onclick="resetAll()" class="btn-gradient text-white px-6 py-3 rounded-xl font-bold text-lg">🔄 إعادة تعيين</button>
            </div>
          </div>

          <div class="border-t border-gray-200 pt-4">
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center"><span class="floating-icon">🤖</span><span class="mr-2">مساعدة القراءة الآلية</span></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <button id="autoReadBtn" onclick="toggleAutoRead()" class="btn-success text-white px-6 py-3 rounded-xl font-bold text-lg">🔊 تشغيل القراءة الآلية</button>
              <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700">سرعة القراءة:</label>
                <select id="readingSpeedSelect" onchange="updateReadingSpeed()" class="p-2 rounded-lg border border-gray-300 text-sm">
                  <option value="0.5">بطيء جداً</option>
                  <option value="0.7">بطيء</option>
                  <option value="1" selected>عادي</option>
                  <option value="1.3">سريع</option>
                  <option value="1.5">سريع جداً</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700">الصوت:</label>
                <select id="voiceSelect" onchange="updateSelectedVoice()" class="p-2 rounded-lg border border-gray-300 text-sm flex-1">
                  <option value="">تحميل الأصوات...</option>
                </select>
              </div>
              <button onclick="testVoice()" class="btn-gradient text-white px-4 py-2 rounded-lg text-sm">🎵 اختبار الصوت</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700">سرعة المؤشر:</label>
                <input type="range" id="cursorSpeedRange" min="0.5" max="3" step="0.1" value="1" onchange="updateCursorSpeed()" class="flex-1" />
                <span id="cursorSpeedValue" class="text-sm font-bold text-blue-600">1.0x</span>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="syncWithAudio" checked onchange="toggleSyncWithAudio()" class="rounded" />
                <label for="syncWithAudio" class="text-sm font-medium text-gray-700">مزامنة مع الصوت</label>
              </div>
            </div>
          </div>

          <div class="border-t border-gray-200 pt-4">
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center"><span class="floating-icon">🎙️</span><span class="mr-2">التسجيل الصوتي</span></h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <button id="recordBtn" onclick="startRecording()" class="btn-gradient text-white px-6 py-3 rounded-xl font-bold text-lg">🔴 ابدأ التسجيل</button>
              <button id="stopRecordBtn" onclick="stopRecording()" class="btn-danger text-white px-6 py-3 rounded-xl font-bold text-lg" disabled>⏹️ إيقاف التسجيل</button>
              <div id="recordingStatus" class="flex items-center justify-center text-gray-600 font-medium">جاهز للتسجيل</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats and Timer Sidebar -->
      <div class="space-y-6">
        <div class="timer-container rounded-2xl p-6 text-center">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-center"><span class="floating-icon">⏱️</span><span class="mr-2">المؤقت</span></h3>
          <div class="relative w-32 h-32 mx-auto mb-4">
            <svg class="w-32 h-32 transform -rotate-90">
              <circle cx="64" cy="64" r="45" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
              <circle id="timerCircle" cx="64" cy="64" r="45" stroke="#3b82f6" stroke-width="8" fill="none" class="timer-circle"></circle>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center"><span id="timerDisplay" class="text-2xl font-bold text-gray-800">00:00</span></div>
          </div>
        </div>

        <div class="stats-card rounded-2xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="floating-icon">📊</span><span class="mr-2">الإحصائيات المباشرة</span></h3>
          <div class="space-y-4">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-xl">
              <div class="text-sm text-gray-600 mb-1">الكلمات المقروءة</div>
              <div id="wordsRead" class="text-2xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-xl">
              <div class="text-sm text-gray-600 mb-1">سرعة القراءة</div>
              <div id="readingSpeed" class="text-2xl font-bold text-green-600">0 ك/د</div>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-xl">
              <div class="text-sm text-gray-600 mb-1">التقدم</div>
              <div class="w-full bg-gray-200 rounded-full h-3 mb-2"><div id="progressBar" class="progress-bar h-3 rounded-full" style="width:0%"></div></div>
              <div id="progressText" class="text-sm font-bold text-purple-600">0%</div>
            </div>
          </div>
        </div>

        <div class="stats-card rounded-2xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="floating-icon">📈</span><span class="mr-2">سجل الجلسات</span></h3>
          <div id="sessionHistory" class="space-y-3 max-h-60 overflow-y-auto"><div class="text-center text-gray-500 py-4">لا توجد جلسات مسجلة بعد</div></div>
        </div>

        <div class="stats-card rounded-2xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="floating-icon">🚀</span><span class="mr-2">مخطط السرعة</span></h3>
          <div class="bg-white rounded-xl p-4"><canvas id="speedChart" width="300" height="200"></canvas></div>
          <div class="mt-3 text-center"><button onclick="clearSpeedChartData()" class="btn-gradient text-white px-4 py-2 rounded-lg text-sm">🗑️ مسح بيانات السرعة</button></div>
        </div>

        <div class="stats-card rounded-2xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="floating-icon">📊</span><span class="mr-2">مخطط التقدم</span></h3>
          <div class="bg-white rounded-xl p-4"><canvas id="progressChart" width="300" height="200"></canvas></div>
          <div class="mt-3 text-center"><button onclick="clearProgressChartData()" class="btn-gradient text-white px-4 py-2 rounded-lg text-sm">🗑️ مسح بيانات التقدم</button></div>
        </div>

        <div class="stats-card rounded-2xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="floating-icon">🎵</span><span class="mr-2">التسجيلات الصوتية</span></h3>
          <div id="audioRecordings" class="space-y-3 max-h-60 overflow-y-auto"><div class="text-center text-gray-500 py-4">لا توجد تسجيلات صوتية بعد</div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== النصوص المتاحة ======
    const texts = [
      { title: "التَّكْنُولُوجِيَا فِي حَيَاتِنَا", content: "تُعْتَبَرُ التَّكْنُولُوجِيَا جُزْءًا لَا يَتَجَزَّأُ مِنْ حَيَاتِنَا الْيَوْمِيَّةِ. فَمِنْ خِلَالِ الْهَوَاتِفِ الذَّكِيَّةِ وَالْحَاسُوبِ، نَسْتَطِيعُ التَّوَاصُلَ مَعَ الْأَصْدِقَاءِ وَالْعَائِلَةِ فِي جَمِيعِ أَنْحَاءِ الْعَالَمِ. كَمَا تُسَاعِدُنَا التَّكْنُولُوجِيَا فِي التَّعَلُّمِ مِنْ خِلَالِ الْمَنَصَّاتِ التَّعْلِيمِيَّةِ وَالْمَكْتَبَاتِ الرَّقْمِيَّةِ. وَفِي الْمَجَالِ الطِّبِّيِّ، تُمَكِّنُ الْأَطِبَّاءَ مِنْ تَشْخِيصِ الْأَمْرَاضِ بِدِقَّةٍ أَكْبَرَ وَعِلَاجِهَا بِطُرُقٍ حَدِيثَةٍ. لَكِنْ يَجِبُ عَلَيْنَا اسْتِخْدَامُ التَّكْنُولُوجِيَا بِحِكْمَةٍ وَعَدَمُ الْإِفْرَاطِ فِيهَا، حَتَّى لَا تُؤَثِّرَ سَلْبًا عَلَى صِحَّتِنَا وَعَلَاقَاتِنَا الِاجْتِمَاعِيَّةِ." },
      { title: "حِمَايَةُ الْبِيئَةِ مَسْؤُولِيَّتُنَا", content: "تُوَاجِهُ بِيئَتُنَا تَحَدِّيَاتٍ كَبِيرَةً فِي الْعَصْرِ الْحَدِيثِ، مِنْهَا التَّلَوُّثُ وَالِاحْتِبَاسُ الْحَرَارِيُّ وَتَدْمِيرُ الْغَابَاتِ. لِذَلِكَ، يَجِبُ عَلَى كُلِّ فَرْدٍ مِنَّا أَنْ يَتَحَمَّلَ مَسْؤُولِيَّتَهُ فِي حِمَايَةِ الْبِيئَةِ. يُمْكِنُنَا الْبَدْءُ بِخُطُوَاتٍ بَسِيطَةٍ مِثْلَ تَوْفِيرِ الْمَاءِ وَالْكَهْرَبَاءِ، وَإِعَادَةِ تَدْوِيرِ الْمَوَادِّ، وَاسْتِخْدَامِ وَسَائِلِ النَّقْلِ الصَّدِيقَةِ لِلْبِيئَةِ. كَمَا يُمْكِنُنَا زِرَاعَةُ الْأَشْجَارِ وَالنَّبَاتَاتِ فِي حَدَائِقِنَا وَمَدَارِسِنَا. إِنَّ الْعَمَلَ الْجَمَاعِيَّ وَالتَّعَاوُنَ بَيْنَ الْأَفْرَادِ وَالْمُؤَسَّسَاتِ ضَرُورِيٌّ لِضَمَانِ مُسْتَقْبَلٍ أَفْضَلَ لِلْأَجْيَالِ الْقَادِمَةِ." },
      { title: "أَهَمِّيَّةُ الْقِرَاءَةِ وَالْمُطَالَعَةِ", content: "تُعَدُّ الْقِرَاءَةُ مِنْ أَهَمِّ الْمَهَارَاتِ الَّتِي يَجِبُ عَلَى الْإِنْسَانِ إِتْقَانُهَا وَتَطْوِيرُهَا. فَهِيَ تَفْتَحُ أَمَامَنَا آفَاقًا وَاسِعَةً مِنَ الْمَعْرِفَةِ وَالثَّقَافَةِ، وَتُنَمِّي قُدْرَاتِنَا الْعَقْلِيَّةَ وَالْإِبْدَاعِيَّةَ. عِنْدَمَا نَقْرَأُ، نَكْتَسِبُ مُفْرَدَاتٍ جَدِيدَةً وَنُحَسِّنُ مِنْ أُسْلُوبِنَا فِي التَّعْبِيرِ وَالْكِتَابَةِ. كَمَا أَنَّ الْقِرَاءَةَ تُسَاعِدُنَا عَلَى فَهْمِ الْعَالَمِ مِنْ حَوْلِنَا وَتُوَسِّعُ مَدَارِكَنَا. وَمِنْ فَوَائِدِهَا أَيْضًا أَنَّهَا تُقَلِّلُ مِنَ التَّوَتُّرِ وَتُحَسِّنُ مِنَ التَّرْكِيزِ وَالذَّاكِرَةِ. لِذَلِكَ، يَنْبَغِي أَنْ نَجْعَلَ الْقِرَاءَةَ عَادَةً يَوْمِيَّةً فِي حَيَاتِنَا، وَأَنْ نَخْتَارَ الْكُتُبَ الَّتِي تُنَاسِبُ اهْتِمَامَاتِنَا وَتُثْرِي مَعْلُومَاتِنَا." }
    ];

    // ====== متغيرات عامة ======
    let isReading = false, isPaused = false, startTime = null, pausedTime = 0, currentWordIndex = 0, words = [], timerInterval = null, currentTextIndex = 0, fontSize = 24, sessions = [];

    // ====== TTS والأصوات ======
    let isAutoReading = false;
    const ttsSupported = typeof window.speechSynthesis !== 'undefined' && typeof window.SpeechSynthesisUtterance !== 'undefined';
    let speechSynthesisRef = ttsSupported ? window.speechSynthesis : null;
    let currentUtterance = null, autoReadSpeed = 1, cursorSpeed = 1, syncWithAudio = true, autoReadInterval = null, selectedVoice = null, availableVoices = [];

    // ====== التسجيل الصوتي ======
    let mediaRecorder = null, audioChunks = [], isRecording = false, audioStream = null, recordingStartTime = null, recordingTimer = null;

    // ====== المخططات ======
    let speedChart = null, progressChart = null;
    let speedChartData = { labels: [], datasets: [{ label: 'سرعة القراءة (كلمة/دقيقة)', data: [], borderColor: 'rgb(59,130,246)', backgroundColor: 'rgba(59,130,246,.1)', tension: .4, fill: true }] };
    let progressChartData = { labels: [], datasets: [{ label: 'نسبة التقدم (%)', data: [], borderColor: 'rgb(16,185,129)', backgroundColor: 'rgba(16,185,129,.1)', tension: .4, fill: true }] };

    // ====== Fallback أصوات قصيرة جاهزة ======
    // ضع ملفات MP3 داخل مجلد voices/ في جذر المشروع بنفس الأسماء.
    const fallbackClips = {
      start: 'voices/start.mp3',     // "بدأت القراءة" مثلاً
      pause: 'voices/pause.mp3',     // "تم الإيقاف مؤقتاً"
      stop: 'voices/stop.mp3',       // "انتهت القراءة"
      rec_start: 'voices/rec_start.mp3', // "بدأ التسجيل"
      rec_stop: 'voices/rec_stop.mp3',   // "توقف التسجيل"
      saved: 'voices/saved.mp3',     // "تم الحفظ"
      error: 'voices/error.mp3'      // رسالة خطأ قصيرة
    };

    function playFallback(name) {
      const src = fallbackClips[name];
      if (!src) return;
      const el = document.getElementById('fallbackAudio');
      el.src = src; el.play().catch(()=>{});
    }

    // ====== تحميل النص المحدد ======
    function loadSelectedText() {
      currentTextIndex = parseInt(document.getElementById('textSelect').value);
      const text = texts[currentTextIndex];
      words = text.content.split(' ');
      const readingTextDiv = document.getElementById('readingText');
      readingTextDiv.innerHTML = words.map((w,i)=>`<span id="word-${i}" class="cursor-pointer hover:bg-yellow-100 transition-colors duration-300 px-2 py-1 rounded-lg font-medium">${w}</span>`).join(' ');
      readingTextDiv.style.fontSize = fontSize + 'px';
      resetReading();
    }

    // ====== حجم الخط ======
    function changeTextSize(action) {
      if (action==='increase' && fontSize<36) fontSize += 3;
      else if (action==='decrease' && fontSize>18) fontSize -= 3;
      const el = document.getElementById('readingText');
      el.style.fontSize = fontSize + 'px';
      if (fontSize>=30){ el.style.lineHeight='3.5'; el.style.wordSpacing='6px'; }
      else if (fontSize>=24){ el.style.lineHeight='3.2'; el.style.wordSpacing='5px'; }
      else { el.style.lineHeight='3'; el.style.wordSpacing='4px'; }
    }

    // ====== القراءة الآلية ======
    function toggleAutoRead(){ isAutoReading ? stopAutoRead() : startAutoRead(); }

    function startAutoRead(){
      if (words.length===0) return;
      if (ttsSupported){
        speechSynthesisRef.cancel();
        isAutoReading = true;
        const text = words.join(' ');
        setTimeout(()=>{
          currentUtterance = new SpeechSynthesisUtterance(text);
          currentUtterance.lang = 'ar-SA';
          currentUtterance.rate = autoReadSpeed; currentUtterance.pitch = 1; currentUtterance.volume = 1;
          if (selectedVoice) currentUtterance.voice = selectedVoice;
          document.getElementById('autoReadBtn').innerHTML = '⏸️ إيقاف القراءة الآلية';
          document.getElementById('autoReadBtn').classList.remove('btn-success');
          document.getElementById('autoReadBtn').classList.add('btn-warning');
          currentUtterance.onstart = ()=>{ showNotification('🔊 بدأت القراءة الآلية','success',2000); };
          currentUtterance.onend = ()=>{ stopAutoRead(); };
          currentUtterance.onerror = (e)=>{ showNotification('❌ خطأ في تشغيل الصوت: '+e.error,'error',3000); stopAutoRead(); playFallback('error'); };
          if (syncWithAudio) startWordTracking();
          try { speechSynthesisRef.speak(currentUtterance); playFallback('start'); } catch(e){ showNotification('❌ تعذر بدء النطق','error'); stopAutoRead(); playFallback('error'); }
        },100);
      } else {
        // غير مدعوم: نعلن للمستخدم ونشغل صوتًا احتياطيًا
        showNotification('⚠️ جهازك لا يدعم القراءة الآلية (Web Speech API). سيتم تشغيل أصوات مساعدة فقط.','warning',5000);
        playFallback('start');
      }
    }

    function stopAutoRead(){
      isAutoReading = false;
      if (ttsSupported && currentUtterance){ speechSynthesisRef.cancel(); currentUtterance = null; }
      if (autoReadInterval){ clearInterval(autoReadInterval); autoReadInterval = null; }
      const btn = document.getElementById('autoReadBtn');
      btn.innerHTML = '🔊 تشغيل القراءة الآلية'; btn.classList.remove('btn-warning'); btn.classList.add('btn-success');
      playFallback('stop');
    }

    function updateReadingSpeed(){
      autoReadSpeed = parseFloat(document.getElementById('readingSpeedSelect').value);
      if (isAutoReading && ttsSupported && currentUtterance){ stopAutoRead(); setTimeout(()=>startAutoRead(),100); }
    }
    function updateCursorSpeed(){ cursorSpeed = parseFloat(document.getElementById('cursorSpeedRange').value); document.getElementById('cursorSpeedValue').textContent = cursorSpeed.toFixed(1)+'x'; }
    function toggleSyncWithAudio(){ syncWithAudio = document.getElementById('syncWithAudio').checked; }

    function startWordTracking(){
      if (!syncWithAudio) return;
      const wordsPerSecond = (autoReadSpeed*2.5)*cursorSpeed; const intervalTime = 1000/wordsPerSecond;
      autoReadInterval = setInterval(()=>{
        if (currentWordIndex < words.length-1 && isAutoReading){ currentWordIndex++; highlightCurrentWord(); updateProgress(); }
        else { clearInterval(autoReadInterval); autoReadInterval=null; }
      }, intervalTime);
    }

    // ====== القراءة اليدوية/العداد ======
    function startReading(){
      if (words.length===0) return; isReading=true; isPaused=false; if (startTime===null){ startTime=Date.now(); } else { startTime = Date.now() - pausedTime; }
      document.getElementById('startBtn').disabled=true; document.getElementById('pauseBtn').disabled=false; document.getElementById('stopBtn').disabled=false;
      startTimer(); highlightCurrentWord(); playFallback('start');
    }

    function pauseReading(){ isReading=false; isPaused=true; pausedTime = Date.now()-startTime; document.getElementById('startBtn').disabled=false; document.getElementById('pauseBtn').disabled=true; clearInterval(timerInterval); playFallback('pause'); }

    function stopReading(){
      isReading=false; isPaused=false; const endTime = Date.now(); const totalTime = Math.floor((endTime-startTime)/1000); const wpm = Math.round((currentWordIndex/Math.max(totalTime,1))*60);
      saveSession(totalTime, currentWordIndex, wpm);
      document.getElementById('startBtn').disabled=false; document.getElementById('pauseBtn').disabled=true; document.getElementById('stopBtn').disabled=true; clearInterval(timerInterval);
      showResults(totalTime, currentWordIndex, wpm); playFallback('stop');
    }

    function resetAll(){ resetReading(); loadSelectedText(); }
    function resetReading(){ isReading=false; isPaused=false; startTime=null; pausedTime=0; currentWordIndex=0; if (isAutoReading) stopAutoRead(); document.getElementById('startBtn').disabled=false; document.getElementById('pauseBtn').disabled=true; document.getElementById('stopBtn').disabled=true; clearInterval(timerInterval); document.getElementById('timerDisplay').textContent='00:00'; document.getElementById('wordsRead').textContent='0'; document.getElementById('readingSpeed').textContent='0 ك/د'; document.getElementById('progressBar').style.width='0%'; document.getElementById('progressText').textContent='0%'; words.forEach((_,i)=>{ const el=document.getElementById(`word-${i}`); if(el) el.classList.remove('word-highlight'); }); }

    function startTimer(){
      timerInterval = setInterval(()=>{
        if (!isReading) return; const now=Date.now(); const elapsed=Math.floor((now-startTime)/1000); updateTimerDisplay(elapsed); updateStats(elapsed); updateProgress(); if (currentWordIndex < words.length-1){ currentWordIndex++; highlightCurrentWord(); } else { stopReading(); }
      },1000);
    }

    function updateTimerDisplay(seconds){ const m=Math.floor(seconds/60); const s=seconds%60; document.getElementById('timerDisplay').textContent=`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; const circumference=283; const progress=(seconds%60)/60; const offset=circumference-(progress*circumference); document.getElementById('timerCircle').style.strokeDashoffset=offset; }
    function updateStats(elapsed){ document.getElementById('wordsRead').textContent=currentWordIndex; if (elapsed>0){ const wpm=Math.round((currentWordIndex/elapsed)*60); document.getElementById('readingSpeed').textContent=wpm+' ك/د'; } }
    function updateProgress(){ const p=(currentWordIndex/words.length)*100; document.getElementById('progressBar').style.width=p+'%'; document.getElementById('progressText').textContent=Math.round(p)+'%'; }
    function highlightCurrentWord(){ if (currentWordIndex>0){ const prev=document.getElementById(`word-${currentWordIndex-1}`); if(prev) prev.classList.remove('word-highlight'); } const cur=document.getElementById(`word-${currentWordIndex}`); if(cur){ cur.classList.add('word-highlight'); cur.scrollIntoView({behavior:'smooth', block:'center'}); } }

    function saveSession(duration, wordsRead, wpm){ const progress=Math.round((wordsRead/words.length)*100); const session={ date:new Date().toLocaleDateString('ar-SA'), time:new Date().toLocaleTimeString('ar-SA'), text:texts[currentTextIndex].title, duration, wordsRead, wpm, progress }; sessions.unshift(session); if(sessions.length>10) sessions.pop(); updateSpeedChart(wpm); updateProgressChart(progress); updateSessionHistory(); }

    // ====== التسجيل الصوتي ======
    async function startRecording(){
      try{
        audioStream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, sampleRate:44100, channelCount:2 } });
        const options = { mimeType:'audio/webm;codecs=opus', audioBitsPerSecond:128000 };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) options.mimeType='audio/webm';
        mediaRecorder = new MediaRecorder(audioStream, options);
        audioChunks = [];
        mediaRecorder.ondataavailable = e=>{ if(e.data.size>0) audioChunks.push(e.data); };
        mediaRecorder.onstop = ()=>{ const mimeType = mediaRecorder.mimeType || 'audio/webm'; const blob = new Blob(audioChunks,{type:mimeType}); saveAudioRecording(blob, mimeType); };
        mediaRecorder.start(1000); isRecording=true;
        document.getElementById('recordBtn').disabled=true; document.getElementById('stopRecordBtn').disabled=false; document.getElementById('recordBtn').classList.add('recording-pulse'); document.getElementById('recordingStatus').innerHTML='جاري التسجيل <span class="recording-indicator"></span>';
        startRecordingTimer(); playFallback('rec_start');
      }catch(err){ console.error(err); let msg='عذراً، لا يمكن الوصول إلى الميكروفون.'; if (err.name==='NotAllowedError') msg='يرجى السماح بالوصول إلى الميكروفون من إعدادات المتصفح.'; else if (err.name==='NotFoundError') msg='لم يتم العثور على ميكروفون.'; alert(msg); playFallback('error'); }
    }

    function startRecordingTimer(){ recordingStartTime=Date.now(); recordingTimer=setInterval(()=>{ const elapsed=Math.floor((Date.now()-recordingStartTime)/1000); const m=Math.floor(elapsed/60); const s=elapsed%60; document.getElementById('recordingStatus').innerHTML=`جاري التسجيل ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')} <span class="recording-indicator"></span>`; },1000); }

    function stopRecording(){ if (mediaRecorder && isRecording){ mediaRecorder.stop(); audioStream.getTracks().forEach(t=>t.stop()); isRecording=false; if(recordingTimer){ clearInterval(recordingTimer); recordingTimer=null; } document.getElementById('recordBtn').disabled=false; document.getElementById('stopRecordBtn').disabled=true; document.getElementById('recordBtn').classList.remove('recording-pulse'); document.getElementById('recordingStatus').innerHTML='⏳ جاري معالجة التسجيل...'; playFallback('rec_stop'); setTimeout(()=>{ document.getElementById('recordingStatus').textContent='جاهز للتسجيل'; },3000); } }

    function saveAudioRecording(audioBlob, mimeType){ const audioUrl = URL.createObjectURL(audioBlob); const now = Date.now(); const dur = recordingStartTime ? Math.floor((now-recordingStartTime)/1000):0; let fileExtension='webm'; if (mimeType.includes('mp4')) fileExtension='mp4'; else if (mimeType.includes('wav')) fileExtension='wav'; else if (mimeType.includes('ogg')) fileExtension='ogg'; const recording={ id:Date.now(), date:new Date().toLocaleDateString('ar-SA'), time:new Date().toLocaleTimeString('ar-SA'), text:texts[currentTextIndex].title, audioUrl, audioBlob, mimeType, fileExtension, duration:dur, size: Math.round(audioBlob.size/1024), wordsRead: currentWordIndex, wpm: dur>0? Math.round((currentWordIndex/dur)*60):0, quality: audioBlob.size>100000?'عالية': audioBlob.size>50000?'متوسطة':'منخفضة' };
      saveToIndexedDB(recording); downloadRecording(audioUrl, recording.text, recording.date, fileExtension); if(!window.audioRecordings) window.audioRecordings=[]; window.audioRecordings.unshift(recording); if(window.audioRecordings.length>20){ const old=window.audioRecordings.pop(); URL.revokeObjectURL(old.audioUrl); } updateAudioRecordings(); showNotification('✅ تم حفظ التسجيل بنجاح على جهازك!','success'); playFallback('saved'); }

    function updateAudioRecordings(){ const wrap=document.getElementById('audioRecordings'); const list=window.audioRecordings||[]; if (list.length===0){ wrap.innerHTML='<div class="text-center text-gray-500 py-4">لا توجد تسجيلات صوتية بعد</div>'; return; } wrap.innerHTML = list.map(r=>`<div class="bg-gradient-to-r from-blue-50 to-blue-100 p-3 rounded-lg border border-blue-200"><div class="flex justify-between items-start mb-2"><div class="text-sm font-bold text-gray-800">${r.text}</div><div class="text-xs text-gray-500">${r.date}</div></div><div class="mb-3"><audio controls class="w-full h-8"><source src="${r.audioUrl}" type="${r.mimeType}">متصفحك لا يدعم تشغيل الصوت</audio></div><div class="grid grid-cols-2 gap-2 text-xs mb-2"><div><span class="text-gray-600">المدة:</span> <span class="font-bold">${Math.floor(r.duration/60)}:${(r.duration%60).toString().padStart(2,'0')}</span></div><div><span class="text-gray-600">الحجم:</span> <span class="font-bold">${r.size} ك.ب</span></div><div><span class="text-gray-600">الكلمات:</span> <span class="font-bold">${r.wordsRead||0}</span></div><div><span class="text-gray-600">السرعة:</span> <span class="font-bold">${r.wpm||0} ك/د</span></div><div><span class="text-gray-600">الجودة:</span> <span class="font-bold">${r.quality||'متوسطة'}</span></div><div><span class="text-gray-600">النوع:</span> <span class="font-bold">${(r.fileExtension||'webm').toUpperCase()}</span></div></div><div class="flex gap-2 flex-wrap"><button onclick="downloadRecording('${r.audioUrl}','${r.text}','${r.date}','${r.fileExtension||'webm'}')" class="btn-gradient text-white px-3 py-1 rounded text-xs">💾 تحميل مرة أخرى</button><button onclick="deleteRecording(${r.id})" class="btn-danger text-white px-3 py-1 rounded text-xs">🗑️ حذف</button><button onclick="shareRecording(${r.id})" class="btn-success text-white px-3 py-1 rounded text-xs">📤 مشاركة</button></div></div>`).join(''); }

    function downloadRecording(audioUrl, textTitle, date, ext='webm'){ const a=document.createElement('a'); a.href=audioUrl; const cleanTitle=textTitle.replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\w\s]/g,''); const cleanDate=date.replace(/[^\d-]/g,'-'); const ts=new Date().toISOString().slice(11,19).replace(/:/g,'-'); a.download=`تسجيل_قراءة_${cleanTitle}_${cleanDate}_${ts}.${ext}`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

    async function deleteRecording(id){ if(confirm('هل أنت متأكد من حذف هذا التسجيل؟')){ const list=window.audioRecordings||[]; const idx=list.findIndex(r=>r.id===id); if(idx!==-1){ URL.revokeObjectURL(list[idx].audioUrl); list.splice(idx,1); try{ const db=await initIndexedDB(); const tx=db.transaction(['recordings'],'readwrite'); const store=tx.objectStore('recordings'); await store.delete(id); }catch(e){ console.error('خطأ في حذف التسجيل',e);} updateAudioRecordings(); } } }

    function shareRecording(id){ const r=(window.audioRecordings||[]).find(x=>x.id===id); if(!r) return; if (navigator.share && r.audioBlob){ navigator.share({ title:`تسجيل قراءة - ${r.text}`, text:`تسجيل قراءة لنص "${r.text}" - المدة: ${Math.floor(r.duration/60)}:${(r.duration%60).toString().padStart(2,'0')} - السرعة: ${r.wpm} كلمة/دقيقة`, files:[new File([r.audioBlob], `تسجيل_${r.text}_${r.date.replace(/\//g,'-')}.${r.fileExtension||'webm'}`, {type:r.mimeType})] }).catch(()=>fallbackShare(r)); } else { fallbackShare(r); } }

    function fallbackShare(r){ const txt=`تسجيل قراءة لنص "${r.text}"\nالمدة: ${Math.floor(r.duration/60)}:${(r.duration%60).toString().padStart(2,'0')}\nالسرعة: ${r.wpm} كلمة/دقيقة\nالكلمات المقروءة: ${r.wordsRead}`; if (navigator.clipboard){ navigator.clipboard.writeText(txt).then(()=>alert('تم نسخ معلومات التسجيل إلى الحافظة!')); } else { prompt('انسخ هذا النص للمشاركة:', txt); } }

    function updateSessionHistory(){ const box=document.getElementById('sessionHistory'); if (sessions.length===0){ box.innerHTML='<div class="text-center text-gray-500 py-4">لا توجد جلسات مسجلة بعد</div>'; return; } box.innerHTML = sessions.map(s=>`<div class="bg-gradient-to-r from-gray-50 to-gray-100 p-3 rounded-lg border border-gray-200"><div class="flex justify-between items-start mb-2"><div class="text-sm font-bold text-gray-800">${s.text}</div><div class="text-xs text-gray-500">${s.date}</div></div><div class="grid grid-cols-2 gap-2 text-xs"><div><span class="text-gray-600">المدة:</span> <span class="font-bold">${Math.floor(s.duration/60)}:${(s.duration%60).toString().padStart(2,'0')}</span></div><div><span class="text-gray-600">السرعة:</span> <span class="font-bold">${s.wpm} ك/د</span></div><div><span class="text-gray-600">الكلمات:</span> <span class="font-bold">${s.wordsRead}</span></div><div><span class="text-gray-600">التقدم:</span> <span class="font-bold">${s.progress}%</span></div></div></div>`).join(''); }

    function showResults(duration, wordsRead, wpm){ const m=Math.floor(duration/60); const s=duration%60; const p=Math.round((wordsRead/words.length)*100); document.querySelector('.timer-container').classList.add('celebration'); setTimeout(()=>{ document.querySelector('.timer-container').classList.remove('celebration'); },600); alert(`🎉 تهانينا! لقد أنهيت جلسة القراءة\n\n⏱️ المدة: ${m}:${s.toString().padStart(2,'0')}\n📖 الكلمات المقروءة: ${wordsRead}\n🚀 السرعة: ${wpm} كلمة/دقيقة\n📊 التقدم: ${p}%`); }

    // ====== المخططات ======
    function initializeCharts(){ const speedCtx=document.getElementById('speedChart').getContext('2d'); const savedS=JSON.parse(localStorage.getItem('speedChartData')||'{"labels":[],"data":[]}'); speedChartData.labels=savedS.labels||[]; speedChartData.datasets[0].data=savedS.data||[]; speedChart=new Chart(speedCtx,{ type:'line', data:speedChartData, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true, labels:{ font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } } }, scales:{ y:{ beginAtZero:true, title:{ display:true, text:'كلمة/دقيقة', font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } }, x:{ title:{ display:true, text:'الجلسات', font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } } } } }); const progressCtx=document.getElementById('progressChart').getContext('2d'); const savedP=JSON.parse(localStorage.getItem('progressChartData')||'{"labels":[],"data":[]}'); progressChartData.labels=savedP.labels||[]; progressChartData.datasets[0].data=savedP.data||[]; progressChart=new Chart(progressCtx,{ type:'bar', data:progressChartData, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true, labels:{ font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } } }, scales:{ y:{ beginAtZero:true, max:100, title:{ display:true, text:'نسبة التقدم (%)', font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } }, x:{ title:{ display:true, text:'الجلسات', font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } } } } }); }

    function updateSpeedChart(wpm){ const n=speedChartData.labels.length+1; speedChartData.labels.push(`جلسة ${n}`); speedChartData.datasets[0].data.push(wpm); if (speedChartData.labels.length>15){ speedChartData.labels.shift(); speedChartData.datasets[0].data.shift(); } speedChart.update(); localStorage.setItem('speedChartData', JSON.stringify({ labels:speedChartData.labels, data:speedChartData.datasets[0].data })); }
    function updateProgressChart(p){ const n=progressChartData.labels.length+1; progressChartData.labels.push(`جلسة ${n}`); progressChartData.datasets[0].data.push(p); if (progressChartData.labels.length>15){ progressChartData.labels.shift(); progressChartData.datasets[0].data.shift(); } progressChart.update(); localStorage.setItem('progressChartData', JSON.stringify({ labels:progressChartData.labels, data:progressChartData.datasets[0].data })); }
    function clearSpeedChartData(){ if (confirm('هل أنت متأكد من مسح جميع بيانات مخطط السرعة؟')){ speedChartData.labels=[]; speedChartData.datasets[0].data=[]; speedChart.update(); localStorage.removeItem('speedChartData'); } }
    function clearProgressChartData(){ if (confirm('هل أنت متأكد من مسح جميع بيانات مخطط التقدم؟')){ progressChartData.labels=[]; progressChartData.datasets[0].data=[]; progressChart.update(); localStorage.removeItem('progressChartData'); } }

    // ====== IndexedDB ======
    function initIndexedDB(){ return new Promise((resolve,reject)=>{ const req=indexedDB.open('ReadingRecordings',1); req.onerror=()=>reject(req.error); req.onsuccess=()=>resolve(req.result); req.onupgradeneeded=(e)=>{ const db=e.target.result; if(!db.objectStoreNames.contains('recordings')){ const store=db.createObjectStore('recordings',{keyPath:'id'}); store.createIndex('date','date',{unique:false}); } }; }); }
    async function saveToIndexedDB(recording){ try{ const db=await initIndexedDB(); const tx=db.transaction(['recordings'],'readwrite'); const store=tx.objectStore('recordings'); const arrayBuffer = await recording.audioBlob.arrayBuffer(); const obj={ ...recording, audioData: arrayBuffer, audioBlob:null, audioUrl:null }; await store.add(obj); }catch(e){ console.error('خطأ في حفظ التسجيل:', e); } }
    async function loadFromIndexedDB(){ try{ const db=await initIndexedDB(); const tx=db.transaction(['recordings'],'readonly'); const store=tx.objectStore('recordings'); const req=store.getAll(); return new Promise((res,rej)=>{ req.onsuccess=()=>{ const list=req.result.map(r=>{ const blob=new Blob([r.audioData],{type:'audio/wav'}); const url=URL.createObjectURL(blob); return { ...r, audioBlob:blob, audioUrl:url, mimeType:'audio/wav' }; }); res(list); }; req.onerror=()=>rej(req.error); }); }catch(e){ console.error('خطأ في تحميل التسجيلات:', e); return []; } }

    // ====== إشعارات ======
    function showNotification(message, type='info', duration=4000){ const container=document.getElementById('notificationContainer'); const div=document.createElement('div'); const bg = type==='success'?'bg-green-500': type==='error'?'bg-red-500': type==='warning'?'bg-yellow-500':'bg-blue-500'; div.className=`${bg} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 max-w-sm`;
      div.innerHTML=`<div class='flex items-center justify-between'><span class='font-medium'>${message}</span><button onclick='this.parentElement.parentElement.remove()' class='ml-3 text-white hover:text-gray-200'>✕</button></div>`; container.appendChild(div); setTimeout(()=>{ div.classList.remove('translate-x-full'); },100); setTimeout(()=>{ div.classList.add('translate-x-full'); setTimeout(()=>{ if(div.parentElement){ div.remove(); } },300); },duration); }

    // ====== تحميل الأصوات (Web Speech API) ======
    function loadVoices(){ return new Promise((resolve)=>{ if(!ttsSupported){ resolve([]); return; } let voices = speechSynthesisRef.getVoices(); if (voices.length>0){ resolve(voices); } else { speechSynthesisRef.onvoiceschanged = ()=>{ voices = speechSynthesisRef.getVoices(); resolve(voices); }; setTimeout(()=>{ voices = speechSynthesisRef.getVoices(); resolve(voices); },1000); } }); }

    async function showAvailableVoices(){ const voices = await loadVoices(); availableVoices = voices; const arabicVoices = voices.filter(v=> v.lang?.includes('ar') || v.name?.includes('Arabic') || v.name?.includes('عربي')); updateVoiceSelect(voices, arabicVoices); if (arabicVoices.length>0){ showNotification(`✅ تم العثور على ${arabicVoices.length} صوت عربي`,'success',3000); selectedVoice = arabicVoices[0]; } else { showNotification('⚠️ لم يتم العثور على أصوات عربية على جهازك — سيتم استخدام الصوت الافتراضي أو الأصوات الاحتياطية','warning',5000); }
    }

    function updateVoiceSelect(allVoices, arabicVoices){ const sel=document.getElementById('voiceSelect'); sel.innerHTML=''; const def=document.createElement('option'); def.value=''; def.textContent='الصوت الافتراضي'; sel.appendChild(def); if (arabicVoices.length>0){ const group=document.createElement('optgroup'); group.label='الأصوات العربية'; arabicVoices.forEach((v,i)=>{ const o=document.createElement('option'); o.value=i+'_arabic'; o.textContent=`${v.name} (${v.lang})`; if(i===0) o.selected=true; group.appendChild(o); }); sel.appendChild(group); }
      const others = allVoices.filter(v=> !v.lang?.includes('ar') && !v.name?.includes('Arabic') && !v.name?.includes('عربي'));
      if (others.length>0){ const g=document.createElement('optgroup'); g.label='أصوات أخرى'; others.forEach((v,i)=>{ const o=document.createElement('option'); o.value=(i+arabicVoices.length)+'_other'; o.textContent=`${v.name} (${v.lang})`; g.appendChild(o); }); sel.appendChild(g); }
    }

    function updateSelectedVoice(){ const sel=document.getElementById('voiceSelect'); const val=sel.value; if(!val){ selectedVoice=null; return; } const [idxStr,type]=val.split('_'); const idx=parseInt(idxStr); const arabic = availableVoices.filter(v=> v.lang?.includes('ar') || v.name?.includes('Arabic') || v.name?.includes('عربي')); if (type==='arabic'){ selectedVoice = arabic[idx]; } else { const others = availableVoices.filter(v=> !v.lang?.includes('ar') && !v.name?.includes('Arabic') && !v.name?.includes('عربي')); selectedVoice = others[idx]; }
    }

    function testVoice(){ if (isAutoReading){ showNotification('⚠️ يرجى إيقاف القراءة الآلية أولاً','warning'); return; } const t='مرحباً، هذا اختبار للصوت المحدد'; if (ttsSupported){ const u=new SpeechSynthesisUtterance(t); u.lang='ar-SA'; u.rate=autoReadSpeed; if (selectedVoice) u.voice=selectedVoice; u.onstart=()=>showNotification('🎵 جاري اختبار الصوت...','info',2000); u.onend=()=>showNotification('✅ انتهى اختبار الصوت','success',2000); u.onerror=()=>{ showNotification('❌ خطأ في اختبار الصوت','error'); playFallback('error'); }; speechSynthesisRef.speak(u); } else { playFallback('start'); showNotification('🔉 تم تشغيل صوت تجريبي احتياطي (لا يوجد دعم TTS على جهازك).','info',4000); } }

    // ====== تهيئة التطبيق ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      loadSelectedText(); initializeCharts(); window.audioRecordings = await loadFromIndexedDB(); updateAudioRecordings(); await showAvailableVoices(); setTimeout(()=>{ showNotification('🎙️ جاهز: يمكنك استخدام القراءة الآلية أو الأصوات الاحتياطية والتسجيل وحفظ الملفات','info',6000); }, 1200);
      document.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); if(!isReading && !isPaused){ startReading(); } else if (isReading){ pauseReading(); } else if (isPaused){ startReading(); } } else if (e.code==='Escape'){ stopReading(); } else if (e.code==='KeyR' && e.ctrlKey){ e.preventDefault(); if(!isRecording){ startRecording(); } else { stopRecording(); } } else if (e.code==='KeyA' && e.ctrlKey){ e.preventDefault(); toggleAutoRead(); } });
    });
  </script>
</body>
</html>
