<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Arabic:wght@400;500;600;700;800&family=Cairo:wght@400;600;700;800&display=swap");

    * { box-sizing: border-box; }
    body {
      font-family: "Noto Sans Arabic", "Amiri", "Cairo", sans-serif;
      background: linear-gradient(135deg, #e0f2fe 0%, #f3e5f5 50%, #fce4ec 100%);
      min-height: 100vh; position: relative; overflow-x: hidden;
    }
    body::before {
      content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background:
        radial-gradient(circle at 20% 80%, rgba(33,150,243,.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(156,39,176,.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(103,58,183,.25) 0%, transparent 50%),
        radial-gradient(circle at 60% 60%, rgba(255,193,7,.2) 0%, transparent 50%);
      pointer-events: none; z-index: -1;
    }
    .glass-card { background: rgba(255,255,255,.85); backdrop-filter: blur(15px); border: 2px solid rgba(255,255,255,.9); box-shadow: 0 12px 40px rgba(0,0,0,.15); }
    .glass-card-dark { background: rgba(255,255,255,.75); backdrop-filter: blur(20px); border: 2px solid rgba(255,255,255,.8); box-shadow: 0 8px 32px rgba(0,0,0,.1); }
    .reading-text { line-height: 3; font-size: 1.5rem; font-weight: 600; color: #1a202c; text-shadow: 0 1px 2px rgba(0,0,0,.05); letter-spacing: .5px; word-spacing: 4px; font-family: "Noto Sans Arabic", "Amiri", serif; }
    .timer-circle { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; filter: drop-shadow(0 0 8px rgba(59,130,246,.5)); }
    .timer-container { background: linear-gradient(145deg, rgba(255,255,255,.3), rgba(255,255,255,.1)); backdrop-filter: blur(20px); border: 2px solid rgba(255,255,255,.3); box-shadow: 0 8px 32px rgba(0,0,0,.1), inset 0 1px 0 rgba(255,255,255,.4); }
    .btn-gradient { background: linear-gradient(145deg, #1976d2, #7b1fa2); border: none; position: relative; overflow: hidden; transition: all .3s ease; box-shadow: 0 6px 20px rgba(25,118,210,.4); font-weight: 600; }
    .btn-gradient:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(25,118,210,.6); }
    .btn-gradient::before { content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent); transition: left .5s; }
    .btn-gradient:hover::before { left: 100%; }
    .btn-success { background: linear-gradient(145deg, #10b981, #059669); box-shadow: 0 4px 15px rgba(16,185,129,.4); }
    .btn-success:hover { box-shadow: 0 8px 25px rgba(16,185,129,.6); }
    .btn-warning { background: linear-gradient(145deg, #f59e0b, #d97706); box-shadow: 0 4px 15px rgba(245,158,11,.4); }
    .btn-warning:hover { box-shadow: 0 8px 25px rgba(245,158,11,.6); }
    .btn-danger { background: linear-gradient(145deg, #ef4444, #dc2626); box-shadow: 0 4px 15px rgba(239,68,68,.4); }
    .btn-danger:hover { box-shadow: 0 8px 25px rgba(239,68,68,.6); }
    .progress-bar { background: linear-gradient(90deg, #10b981, #059669); transition: width .3s ease; box-shadow: 0 2px 10px rgba(16,185,129,.3); }
    .stats-card { background: linear-gradient(145deg, rgba(255,255,255,.9), rgba(255,255,255,.7)); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.8); transition: all .3s ease; }
    .stats-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,.1); }
    .word-highlight { background: linear-gradient(120deg, #fef3c7, #fde68a); padding: 4px 8px; border-radius: 8px; border: 2px solid #f59e0b; font-weight: 700; font-size: 1.1em; animation: pulse 2s infinite; box-shadow: 0 2px 8px rgba(245,158,11,.3); }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }
    .celebration { animation: celebrate .6s ease-in-out; }
    @keyframes celebrate { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }
    .floating-icon { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    .recording-pulse { animation: recordingPulse 1.5s ease-in-out infinite; }
    @keyframes recordingPulse { 0%,100%{ background: linear-gradient(145deg,#ef4444,#dc2626); box-shadow:0 4px 15px rgba(239,68,68,.4);} 50%{ background: linear-gradient(145deg,#f87171,#ef4444); box-shadow:0 8px 25px rgba(239,68,68,.8);} }
    .recording-indicator { display:inline-block; width:12px; height:12px; background:#ef4444; border-radius:50%; animation: blink 1s infinite; margin-left:8px; }
    @keyframes blink { 0%,50%{opacity:1} 51%,100%{opacity:.3} }
  </style>
</head>
<body class="p-4">
  <!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
  <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- ADDED: Ø¹Ù†ØµØ± ØµÙˆØª Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„ØªØ´ØºÙŠÙ„ Ù…Ù„ÙØ§Øª MP3 Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ØªÙˆÙØ± Ø£ØµÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
  <audio id="fallbackAudio" preload="auto"></audio>

  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">ğŸ“š Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</h1>
      <p class="text-lg text-gray-600 font-medium">Ø·ÙˆØ± Ù…Ù‡Ø§Ø±Ø§ØªÙƒ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¹ Ø§Ù„ØªÙˆÙ‚ÙŠØª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø©</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Reading Area -->
      <div class="lg:col-span-2">
        <div class="glass-card rounded-2xl p-6 mb-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center"><span class="floating-icon">ğŸ“–</span><span class="mr-3">Ù†Øµ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</span></h2>
            <div class="flex gap-2">
              <button onclick="changeTextSize('increase')" class="btn-gradient text-white px-4 py-2 rounded-lg text-sm">Ø£+</button>
              <button onclick="changeTextSize('decrease')" class="btn-gradient text-white px-4 py-2 rounded-lg text-sm">Ø£-</button>
            </div>
          </div>

          <div class="mb-4">
            <select id="textSelect" onchange="loadSelectedText()" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none font-medium">
              <option value="0">Ø§Ù„Ù†Øµ Ø§Ù„Ø£ÙˆÙ„ - Ø§Ù„ØªÙÙ‘ÙƒÙ’Ù†ÙÙˆÙ„ÙÙˆØ¬ÙÙŠÙØ§ ÙÙÙŠ Ø­ÙÙŠÙØ§ØªÙÙ†ÙØ§</option>
              <option value="1">Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ù†ÙŠ - Ø­ÙÙ…ÙØ§ÙŠÙØ©Ù Ø§Ù„Ù’Ø¨ÙÙŠØ¦ÙØ©Ù Ù…ÙØ³Ù’Ø¤ÙÙˆÙ„ÙÙŠÙÙ‘ØªÙÙ†ÙØ§</option>
              <option value="2">Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ù„Ø« - Ø£ÙÙ‡ÙÙ…ÙÙ‘ÙŠÙÙ‘Ø©Ù Ø§Ù„Ù’Ù‚ÙØ±ÙØ§Ø¡ÙØ©Ù ÙˆÙØ§Ù„Ù’Ù…ÙØ·ÙØ§Ù„ÙØ¹ÙØ©Ù</option>
            </select>
          </div>

          <div id="readingText" class="reading-text p-8 bg-gradient-to-br from-white to-blue-50 rounded-xl border-2 border-blue-200 min-h-[350px] shadow-inner"></div>
        </div>

        <!-- Controls -->
        <div class="glass-card rounded-2xl p-6">
          <div class="mb-4">
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center"><span class="floating-icon">ğŸ®</span><span class="mr-2">Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ…</span></h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <button id="startBtn" onclick="startReading()" class="btn-success text-white px-6 py-3 rounded-xl font-bold text-lg">ğŸ¯ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</button>
              <button id="pauseBtn" onclick="pauseReading()" class="btn-warning text-white px-6 py-3 rounded-xl font-bold text-lg" disabled>â¸ï¸ ØªÙˆÙ‚Ù</button>
              <button id="stopBtn" onclick="stopReading()" class="btn-danger text-white px-6 py-3 rounded-xl font-bold text-lg" disabled>â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡</button>
              <button onclick="resetAll()" class="btn-gradient text-white px-6 py-3 rounded-xl font-bold text-lg">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
          </div>

          <div class="border-t border-gray-200 pt-4">
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center"><span class="floating-icon">ğŸ¤–</span><span class="mr-2">Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù„ÙŠØ©</span></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <button id="autoReadBtn" onclick="toggleAutoRead()" class="btn-success text-white px-6 py-3 rounded-xl font-bold text-lg">ğŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù„ÙŠØ©</button>
              <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700">Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:</label>
                <select id="readingSpeedSelect" onchange="updateReadingSpeed()" class="p-2 rounded-lg border border-gray-300 text-sm">
                  <option value="0.5">Ø¨Ø·ÙŠØ¡ Ø¬Ø¯Ø§Ù‹</option>
                  <option value="0.7">Ø¨Ø·ÙŠØ¡</option>
                  <option value="1" selected>Ø¹Ø§Ø¯ÙŠ</option>
                  <option value="1.3">Ø³Ø±ÙŠØ¹</option>
                  <option value="1.5">Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700">Ø§Ù„ØµÙˆØª:</label>
                <select id="voiceSelect" onchange="updateSelectedVoice()" class="p-2 rounded-lg border border-gray-300 text-sm flex-1">
                  <option value="">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª...</option>
                </select>
              </div>
              <button onclick="testVoice()" class="btn-gradient text-white px-4 py-2 rounded-lg text-sm">ğŸµ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700">Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø¤Ø´Ø±:</label>
                <input type="range" id="cursorSpeedRange" min="0.5" max="3" step="0.1" value="1" onchange="updateCursorSpeed()" class="flex-1" />
                <span id="cursorSpeedValue" class="text-sm font-bold text-blue-600">1.0x</span>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="syncWithAudio" checked onchange="toggleSyncWithAudio()" class="rounded" />
                <label for="syncWithAudio" class="text-sm font-medium text-gray-700">Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„ØµÙˆØª</label>
              </div>
            </div>
          </div>

          <div class="border-t border-gray-200 pt-4">
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center"><span class="floating-icon">ğŸ™ï¸</span><span class="mr-2">Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ</span></h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <button id="recordBtn" onclick="startRecording()" class="btn-gradient text-white px-6 py-3 rounded-xl font-bold text-lg">ğŸ”´ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
              <button id="stopRecordBtn" onclick="stopRecording()" class="btn-danger text-white px-6 py-3 rounded-xl font-bold text-lg" disabled>â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
              <div id="recordingStatus" class="flex items-center justify-center text-gray-600 font-medium">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats and Timer Sidebar -->
      <div class="space-y-6">
        <div class="timer-container rounded-2xl p-6 text-center">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-center"><span class="floating-icon">â±ï¸</span><span class="mr-2">Ø§Ù„Ù…Ø¤Ù‚Øª</span></h3>
          <div class="relative w-32 h-32 mx-auto mb-4">
            <svg class="w-32 h-32 transform -rotate-90">
              <circle cx="64" cy="64" r="45" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
              <circle id="timerCircle" cx="64" cy="64" r="45" stroke="#3b82f6" stroke-width="8" fill="none" class="timer-circle"></circle>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center"><span id="timerDisplay" class="text-2xl font-bold text-gray-800">00:00</span></div>
          </div>
        </div>

        <div class="stats-card rounded-2xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="floating-icon">ğŸ“Š</span><span class="mr-2">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</span></h3>
          <div class="space-y-4">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-xl">
              <div class="text-sm text-gray-600 mb-1">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©</div>
              <div id="wordsRead" class="text-2xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-xl">
              <div class="text-sm text-gray-600 mb-1">Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</div>
              <div id="readingSpeed" class="text-2xl font-bold text-green-600">0 Ùƒ/Ø¯</div>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-xl">
              <div class="text-sm text-gray-600 mb-1">Ø§Ù„ØªÙ‚Ø¯Ù…</div>
              <div class="w-full bg-gray-200 rounded-full h-3 mb-2"><div id="progressBar" class="progress-bar h-3 rounded-full" style="width:0%"></div></div>
              <div id="progressText" class="text-sm font-bold text-purple-600">0%</div>
            </div>
          </div>
        </div>

        <div class="stats-card rounded-2xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="floating-icon">ğŸ“ˆ</span><span class="mr-2">Ø³Ø¬Ù„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</span></h3>
          <div id="sessionHistory" class="space-y-3 max-h-60 overflow-y-auto"><div class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</div></div>
        </div>

        <div class="stats-card rounded-2xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="floating-icon">ğŸš€</span><span class="mr-2">Ù…Ø®Ø·Ø· Ø§Ù„Ø³Ø±Ø¹Ø©</span></h3>
          <div class="bg-white rounded-xl p-4"><canvas id="speedChart" width="300" height="200"></canvas></div>
          <div class="mt-3 text-center"><button onclick="clearSpeedChartData()" class="btn-gradient text-white px-4 py-2 rounded-lg text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø±Ø¹Ø©</button></div>
        </div>

        <div class="stats-card rounded-2xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="floating-icon">ğŸ“Š</span><span class="mr-2">Ù…Ø®Ø·Ø· Ø§Ù„ØªÙ‚Ø¯Ù…</span></h3>
          <div class="bg-white rounded-xl p-4"><canvas id="progressChart" width="300" height="200"></canvas></div>
          <div class="mt-3 text-center"><button onclick="clearProgressChartData()" class="btn-gradient text-white px-4 py-2 rounded-lg text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø¯Ù…</button></div>
        </div>

        <div class="stats-card rounded-2xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="floating-icon">ğŸµ</span><span class="mr-2">Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©</span></h3>
          <div id="audioRecordings" class="space-y-3 max-h-60 overflow-y-auto"><div class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª ØµÙˆØªÙŠØ© Ø¨Ø¹Ø¯</div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªØ§Ø­Ø© ======
    const texts = [
      { title: "Ø§Ù„ØªÙÙ‘ÙƒÙ’Ù†ÙÙˆÙ„ÙÙˆØ¬ÙÙŠÙØ§ ÙÙÙŠ Ø­ÙÙŠÙØ§ØªÙÙ†ÙØ§", content: "ØªÙØ¹Ù’ØªÙØ¨ÙØ±Ù Ø§Ù„ØªÙÙ‘ÙƒÙ’Ù†ÙÙˆÙ„ÙÙˆØ¬ÙÙŠÙØ§ Ø¬ÙØ²Ù’Ø¡Ù‹Ø§ Ù„ÙØ§ ÙŠÙØªÙØ¬ÙØ²ÙÙ‘Ø£Ù Ù…ÙÙ†Ù’ Ø­ÙÙŠÙØ§ØªÙÙ†ÙØ§ Ø§Ù„Ù’ÙŠÙÙˆÙ’Ù…ÙÙŠÙÙ‘Ø©Ù. ÙÙÙ…ÙÙ†Ù’ Ø®ÙÙ„ÙØ§Ù„Ù Ø§Ù„Ù’Ù‡ÙÙˆÙØ§ØªÙÙÙ Ø§Ù„Ø°ÙÙ‘ÙƒÙÙŠÙÙ‘Ø©Ù ÙˆÙØ§Ù„Ù’Ø­ÙØ§Ø³ÙÙˆØ¨ÙØŒ Ù†ÙØ³Ù’ØªÙØ·ÙÙŠØ¹Ù Ø§Ù„ØªÙÙ‘ÙˆÙØ§ØµÙÙ„Ù Ù…ÙØ¹Ù Ø§Ù„Ù’Ø£ÙØµÙ’Ø¯ÙÙ‚ÙØ§Ø¡Ù ÙˆÙØ§Ù„Ù’Ø¹ÙØ§Ø¦ÙÙ„ÙØ©Ù ÙÙÙŠ Ø¬ÙÙ…ÙÙŠØ¹Ù Ø£ÙÙ†Ù’Ø­ÙØ§Ø¡Ù Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…Ù. ÙƒÙÙ…ÙØ§ ØªÙØ³ÙØ§Ø¹ÙØ¯ÙÙ†ÙØ§ Ø§Ù„ØªÙÙ‘ÙƒÙ’Ù†ÙÙˆÙ„ÙÙˆØ¬ÙÙŠÙØ§ ÙÙÙŠ Ø§Ù„ØªÙÙ‘Ø¹ÙÙ„ÙÙ‘Ù…Ù Ù…ÙÙ†Ù’ Ø®ÙÙ„ÙØ§Ù„Ù Ø§Ù„Ù’Ù…ÙÙ†ÙØµÙÙ‘Ø§ØªÙ Ø§Ù„ØªÙÙ‘Ø¹Ù’Ù„ÙÙŠÙ…ÙÙŠÙÙ‘Ø©Ù ÙˆÙØ§Ù„Ù’Ù…ÙÙƒÙ’ØªÙØ¨ÙØ§ØªÙ Ø§Ù„Ø±ÙÙ‘Ù‚Ù’Ù…ÙÙŠÙÙ‘Ø©Ù. ÙˆÙÙÙÙŠ Ø§Ù„Ù’Ù…ÙØ¬ÙØ§Ù„Ù Ø§Ù„Ø·ÙÙ‘Ø¨ÙÙ‘ÙŠÙÙ‘ØŒ ØªÙÙ…ÙÙƒÙÙ‘Ù†Ù Ø§Ù„Ù’Ø£ÙØ·ÙØ¨ÙÙ‘Ø§Ø¡Ù Ù…ÙÙ†Ù’ ØªÙØ´Ù’Ø®ÙÙŠØµÙ Ø§Ù„Ù’Ø£ÙÙ…Ù’Ø±ÙØ§Ø¶Ù Ø¨ÙØ¯ÙÙ‚ÙÙ‘Ø©Ù Ø£ÙÙƒÙ’Ø¨ÙØ±Ù ÙˆÙØ¹ÙÙ„ÙØ§Ø¬ÙÙ‡ÙØ§ Ø¨ÙØ·ÙØ±ÙÙ‚Ù Ø­ÙØ¯ÙÙŠØ«ÙØ©Ù. Ù„ÙÙƒÙÙ†Ù’ ÙŠÙØ¬ÙØ¨Ù Ø¹ÙÙ„ÙÙŠÙ’Ù†ÙØ§ Ø§Ø³Ù’ØªÙØ®Ù’Ø¯ÙØ§Ù…Ù Ø§Ù„ØªÙÙ‘ÙƒÙ’Ù†ÙÙˆÙ„ÙÙˆØ¬ÙÙŠÙØ§ Ø¨ÙØ­ÙÙƒÙ’Ù…ÙØ©Ù ÙˆÙØ¹ÙØ¯ÙÙ…Ù Ø§Ù„Ù’Ø¥ÙÙÙ’Ø±ÙØ§Ø·Ù ÙÙÙŠÙ‡ÙØ§ØŒ Ø­ÙØªÙÙ‘Ù‰ Ù„ÙØ§ ØªÙØ¤ÙØ«ÙÙ‘Ø±Ù Ø³ÙÙ„Ù’Ø¨Ù‹Ø§ Ø¹ÙÙ„ÙÙ‰ ØµÙØ­ÙÙ‘ØªÙÙ†ÙØ§ ÙˆÙØ¹ÙÙ„ÙØ§Ù‚ÙØ§ØªÙÙ†ÙØ§ Ø§Ù„ÙØ§Ø¬Ù’ØªÙÙ…ÙØ§Ø¹ÙÙŠÙÙ‘Ø©Ù." },
      { title: "Ø­ÙÙ…ÙØ§ÙŠÙØ©Ù Ø§Ù„Ù’Ø¨ÙÙŠØ¦ÙØ©Ù Ù…ÙØ³Ù’Ø¤ÙÙˆÙ„ÙÙŠÙÙ‘ØªÙÙ†ÙØ§", content: "ØªÙÙˆÙØ§Ø¬ÙÙ‡Ù Ø¨ÙÙŠØ¦ÙØªÙÙ†ÙØ§ ØªÙØ­ÙØ¯ÙÙ‘ÙŠÙØ§ØªÙ ÙƒÙØ¨ÙÙŠØ±ÙØ©Ù‹ ÙÙÙŠ Ø§Ù„Ù’Ø¹ÙØµÙ’Ø±Ù Ø§Ù„Ù’Ø­ÙØ¯ÙÙŠØ«ÙØŒ Ù…ÙÙ†Ù’Ù‡ÙØ§ Ø§Ù„ØªÙÙ‘Ù„ÙÙˆÙÙ‘Ø«Ù ÙˆÙØ§Ù„ÙØ§Ø­Ù’ØªÙØ¨ÙØ§Ø³Ù Ø§Ù„Ù’Ø­ÙØ±ÙØ§Ø±ÙÙŠÙÙ‘ ÙˆÙØªÙØ¯Ù’Ù…ÙÙŠØ±Ù Ø§Ù„Ù’ØºÙØ§Ø¨ÙØ§ØªÙ. Ù„ÙØ°ÙÙ„ÙÙƒÙØŒ ÙŠÙØ¬ÙØ¨Ù Ø¹ÙÙ„ÙÙ‰ ÙƒÙÙ„ÙÙ‘ ÙÙØ±Ù’Ø¯Ù Ù…ÙÙ†ÙÙ‘Ø§ Ø£ÙÙ†Ù’ ÙŠÙØªÙØ­ÙÙ…ÙÙ‘Ù„Ù Ù…ÙØ³Ù’Ø¤ÙÙˆÙ„ÙÙŠÙÙ‘ØªÙÙ‡Ù ÙÙÙŠ Ø­ÙÙ…ÙØ§ÙŠÙØ©Ù Ø§Ù„Ù’Ø¨ÙÙŠØ¦ÙØ©Ù. ÙŠÙÙ…Ù’ÙƒÙÙ†ÙÙ†ÙØ§ Ø§Ù„Ù’Ø¨ÙØ¯Ù’Ø¡Ù Ø¨ÙØ®ÙØ·ÙÙˆÙØ§ØªÙ Ø¨ÙØ³ÙÙŠØ·ÙØ©Ù Ù…ÙØ«Ù’Ù„Ù ØªÙÙˆÙ’ÙÙÙŠØ±Ù Ø§Ù„Ù’Ù…ÙØ§Ø¡Ù ÙˆÙØ§Ù„Ù’ÙƒÙÙ‡Ù’Ø±ÙØ¨ÙØ§Ø¡ÙØŒ ÙˆÙØ¥ÙØ¹ÙØ§Ø¯ÙØ©Ù ØªÙØ¯Ù’ÙˆÙÙŠØ±Ù Ø§Ù„Ù’Ù…ÙÙˆÙØ§Ø¯ÙÙ‘ØŒ ÙˆÙØ§Ø³Ù’ØªÙØ®Ù’Ø¯ÙØ§Ù…Ù ÙˆÙØ³ÙØ§Ø¦ÙÙ„Ù Ø§Ù„Ù†ÙÙ‘Ù‚Ù’Ù„Ù Ø§Ù„ØµÙÙ‘Ø¯ÙÙŠÙ‚ÙØ©Ù Ù„ÙÙ„Ù’Ø¨ÙÙŠØ¦ÙØ©Ù. ÙƒÙÙ…ÙØ§ ÙŠÙÙ…Ù’ÙƒÙÙ†ÙÙ†ÙØ§ Ø²ÙØ±ÙØ§Ø¹ÙØ©Ù Ø§Ù„Ù’Ø£ÙØ´Ù’Ø¬ÙØ§Ø±Ù ÙˆÙØ§Ù„Ù†ÙÙ‘Ø¨ÙØ§ØªÙØ§ØªÙ ÙÙÙŠ Ø­ÙØ¯ÙØ§Ø¦ÙÙ‚ÙÙ†ÙØ§ ÙˆÙÙ…ÙØ¯ÙØ§Ø±ÙØ³ÙÙ†ÙØ§. Ø¥ÙÙ†ÙÙ‘ Ø§Ù„Ù’Ø¹ÙÙ…ÙÙ„Ù Ø§Ù„Ù’Ø¬ÙÙ…ÙØ§Ø¹ÙÙŠÙÙ‘ ÙˆÙØ§Ù„ØªÙÙ‘Ø¹ÙØ§ÙˆÙÙ†Ù Ø¨ÙÙŠÙ’Ù†Ù Ø§Ù„Ù’Ø£ÙÙÙ’Ø±ÙØ§Ø¯Ù ÙˆÙØ§Ù„Ù’Ù…ÙØ¤ÙØ³ÙÙ‘Ø³ÙØ§ØªÙ Ø¶ÙØ±ÙÙˆØ±ÙÙŠÙŒÙ‘ Ù„ÙØ¶ÙÙ…ÙØ§Ù†Ù Ù…ÙØ³Ù’ØªÙÙ‚Ù’Ø¨ÙÙ„Ù Ø£ÙÙÙ’Ø¶ÙÙ„Ù Ù„ÙÙ„Ù’Ø£ÙØ¬Ù’ÙŠÙØ§Ù„Ù Ø§Ù„Ù’Ù‚ÙØ§Ø¯ÙÙ…ÙØ©Ù." },
      { title: "Ø£ÙÙ‡ÙÙ…ÙÙ‘ÙŠÙÙ‘Ø©Ù Ø§Ù„Ù’Ù‚ÙØ±ÙØ§Ø¡ÙØ©Ù ÙˆÙØ§Ù„Ù’Ù…ÙØ·ÙØ§Ù„ÙØ¹ÙØ©Ù", content: "ØªÙØ¹ÙØ¯ÙÙ‘ Ø§Ù„Ù’Ù‚ÙØ±ÙØ§Ø¡ÙØ©Ù Ù…ÙÙ†Ù’ Ø£ÙÙ‡ÙÙ…ÙÙ‘ Ø§Ù„Ù’Ù…ÙÙ‡ÙØ§Ø±ÙØ§ØªÙ Ø§Ù„ÙÙ‘ØªÙÙŠ ÙŠÙØ¬ÙØ¨Ù Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù’Ø¥ÙÙ†Ù’Ø³ÙØ§Ù†Ù Ø¥ÙØªÙ’Ù‚ÙØ§Ù†ÙÙ‡ÙØ§ ÙˆÙØªÙØ·Ù’ÙˆÙÙŠØ±ÙÙ‡ÙØ§. ÙÙÙ‡ÙÙŠÙ ØªÙÙÙ’ØªÙØ­Ù Ø£ÙÙ…ÙØ§Ù…ÙÙ†ÙØ§ Ø¢ÙÙØ§Ù‚Ù‹Ø§ ÙˆÙØ§Ø³ÙØ¹ÙØ©Ù‹ Ù…ÙÙ†Ù Ø§Ù„Ù’Ù…ÙØ¹Ù’Ø±ÙÙÙØ©Ù ÙˆÙØ§Ù„Ø«ÙÙ‘Ù‚ÙØ§ÙÙØ©ÙØŒ ÙˆÙØªÙÙ†ÙÙ…ÙÙ‘ÙŠ Ù‚ÙØ¯Ù’Ø±ÙØ§ØªÙÙ†ÙØ§ Ø§Ù„Ù’Ø¹ÙÙ‚Ù’Ù„ÙÙŠÙÙ‘Ø©Ù ÙˆÙØ§Ù„Ù’Ø¥ÙØ¨Ù’Ø¯ÙØ§Ø¹ÙÙŠÙÙ‘Ø©Ù. Ø¹ÙÙ†Ù’Ø¯ÙÙ…ÙØ§ Ù†ÙÙ‚Ù’Ø±ÙØ£ÙØŒ Ù†ÙÙƒÙ’ØªÙØ³ÙØ¨Ù Ù…ÙÙÙ’Ø±ÙØ¯ÙØ§ØªÙ Ø¬ÙØ¯ÙÙŠØ¯ÙØ©Ù‹ ÙˆÙÙ†ÙØ­ÙØ³ÙÙ‘Ù†Ù Ù…ÙÙ†Ù’ Ø£ÙØ³Ù’Ù„ÙÙˆØ¨ÙÙ†ÙØ§ ÙÙÙŠ Ø§Ù„ØªÙÙ‘Ø¹Ù’Ø¨ÙÙŠØ±Ù ÙˆÙØ§Ù„Ù’ÙƒÙØªÙØ§Ø¨ÙØ©Ù. ÙƒÙÙ…ÙØ§ Ø£ÙÙ†ÙÙ‘ Ø§Ù„Ù’Ù‚ÙØ±ÙØ§Ø¡ÙØ©Ù ØªÙØ³ÙØ§Ø¹ÙØ¯ÙÙ†ÙØ§ Ø¹ÙÙ„ÙÙ‰ ÙÙÙ‡Ù’Ù…Ù Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…Ù Ù…ÙÙ†Ù’ Ø­ÙÙˆÙ’Ù„ÙÙ†ÙØ§ ÙˆÙØªÙÙˆÙØ³ÙÙ‘Ø¹Ù Ù…ÙØ¯ÙØ§Ø±ÙÙƒÙÙ†ÙØ§. ÙˆÙÙ…ÙÙ†Ù’ ÙÙÙˆÙØ§Ø¦ÙØ¯ÙÙ‡ÙØ§ Ø£ÙÙŠÙ’Ø¶Ù‹Ø§ Ø£ÙÙ†ÙÙ‘Ù‡ÙØ§ ØªÙÙ‚ÙÙ„ÙÙ‘Ù„Ù Ù…ÙÙ†Ù Ø§Ù„ØªÙÙ‘ÙˆÙØªÙÙ‘Ø±Ù ÙˆÙØªÙØ­ÙØ³ÙÙ‘Ù†Ù Ù…ÙÙ†Ù Ø§Ù„ØªÙÙ‘Ø±Ù’ÙƒÙÙŠØ²Ù ÙˆÙØ§Ù„Ø°ÙÙ‘Ø§ÙƒÙØ±ÙØ©Ù. Ù„ÙØ°ÙÙ„ÙÙƒÙØŒ ÙŠÙÙ†Ù’Ø¨ÙØºÙÙŠ Ø£ÙÙ†Ù’ Ù†ÙØ¬Ù’Ø¹ÙÙ„Ù Ø§Ù„Ù’Ù‚ÙØ±ÙØ§Ø¡ÙØ©Ù Ø¹ÙØ§Ø¯ÙØ©Ù‹ ÙŠÙÙˆÙ’Ù…ÙÙŠÙÙ‘Ø©Ù‹ ÙÙÙŠ Ø­ÙÙŠÙØ§ØªÙÙ†ÙØ§ØŒ ÙˆÙØ£ÙÙ†Ù’ Ù†ÙØ®Ù’ØªÙØ§Ø±Ù Ø§Ù„Ù’ÙƒÙØªÙØ¨Ù Ø§Ù„ÙÙ‘ØªÙÙŠ ØªÙÙ†ÙØ§Ø³ÙØ¨Ù Ø§Ù‡Ù’ØªÙÙ…ÙØ§Ù…ÙØ§ØªÙÙ†ÙØ§ ÙˆÙØªÙØ«Ù’Ø±ÙÙŠ Ù…ÙØ¹Ù’Ù„ÙÙˆÙ…ÙØ§ØªÙÙ†ÙØ§." }
    ];

    // ====== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ======
    let isReading = false, isPaused = false, startTime = null, pausedTime = 0, currentWordIndex = 0, words = [], timerInterval = null, currentTextIndex = 0, fontSize = 24, sessions = [];

    // ====== TTS ÙˆØ§Ù„Ø£ØµÙˆØ§Øª ======
    let isAutoReading = false;
    const ttsSupported = typeof window.speechSynthesis !== 'undefined' && typeof window.SpeechSynthesisUtterance !== 'undefined';
    let speechSynthesisRef = ttsSupported ? window.speechSynthesis : null;
    let currentUtterance = null, autoReadSpeed = 1, cursorSpeed = 1, syncWithAudio = true, autoReadInterval = null, selectedVoice = null, availableVoices = [];

    // ====== Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ ======
    let mediaRecorder = null, audioChunks = [], isRecording = false, audioStream = null, recordingStartTime = null, recordingTimer = null;

    // ====== Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª ======
    let speedChart = null, progressChart = null;
    let speedChartData = { labels: [], datasets: [{ label: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©)', data: [], borderColor: 'rgb(59,130,246)', backgroundColor: 'rgba(59,130,246,.1)', tension: .4, fill: true }] };
    let progressChartData = { labels: [], datasets: [{ label: 'Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù… (%)', data: [], borderColor: 'rgb(16,185,129)', backgroundColor: 'rgba(16,185,129,.1)', tension: .4, fill: true }] };

    // ====== Fallback Ø£ØµÙˆØ§Øª Ù‚ØµÙŠØ±Ø© Ø¬Ø§Ù‡Ø²Ø© ======
    // Ø¶Ø¹ Ù…Ù„ÙØ§Øª MP3 Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ voices/ ÙÙŠ Ø¬Ø°Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡.
    const fallbackClips = {
      start: 'voices/start.mp3',     // "Ø¨Ø¯Ø£Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©" Ù…Ø«Ù„Ø§Ù‹
      pause: 'voices/pause.mp3',     // "ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚ØªØ§Ù‹"
      stop: 'voices/stop.mp3',       // "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©"
      rec_start: 'voices/rec_start.mp3', // "Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„"
      rec_stop: 'voices/rec_stop.mp3',   // "ØªÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„"
      saved: 'voices/saved.mp3',     // "ØªÙ… Ø§Ù„Ø­ÙØ¸"
      error: 'voices/error.mp3'      // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù‚ØµÙŠØ±Ø©
    };

    function playFallback(name) {
      const src = fallbackClips[name];
      if (!src) return;
      const el = document.getElementById('fallbackAudio');
      el.src = src; el.play().catch(()=>{});
    }

    // ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­Ø¯Ø¯ ======
    function loadSelectedText() {
      currentTextIndex = parseInt(document.getElementById('textSelect').value);
      const text = texts[currentTextIndex];
      words = text.content.split(' ');
      const readingTextDiv = document.getElementById('readingText');
      readingTextDiv.innerHTML = words.map((w,i)=>`<span id="word-${i}" class="cursor-pointer hover:bg-yellow-100 transition-colors duration-300 px-2 py-1 rounded-lg font-medium">${w}</span>`).join(' ');
      readingTextDiv.style.fontSize = fontSize + 'px';
      resetReading();
    }

    // ====== Ø­Ø¬Ù… Ø§Ù„Ø®Ø· ======
    function changeTextSize(action) {
      if (action==='increase' && fontSize<36) fontSize += 3;
      else if (action==='decrease' && fontSize>18) fontSize -= 3;
      const el = document.getElementById('readingText');
      el.style.fontSize = fontSize + 'px';
      if (fontSize>=30){ el.style.lineHeight='3.5'; el.style.wordSpacing='6px'; }
      else if (fontSize>=24){ el.style.lineHeight='3.2'; el.style.wordSpacing='5px'; }
      else { el.style.lineHeight='3'; el.style.wordSpacing='4px'; }
    }

    // ====== Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù„ÙŠØ© ======
    function toggleAutoRead(){ isAutoReading ? stopAutoRead() : startAutoRead(); }

    function startAutoRead(){
      if (words.length===0) return;
      if (ttsSupported){
        speechSynthesisRef.cancel();
        isAutoReading = true;
        const text = words.join(' ');
        setTimeout(()=>{
          currentUtterance = new SpeechSynthesisUtterance(text);
          currentUtterance.lang = 'ar-SA';
          currentUtterance.rate = autoReadSpeed; currentUtterance.pitch = 1; currentUtterance.volume = 1;
          if (selectedVoice) currentUtterance.voice = selectedVoice;
          document.getElementById('autoReadBtn').innerHTML = 'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù„ÙŠØ©';
          document.getElementById('autoReadBtn').classList.remove('btn-success');
          document.getElementById('autoReadBtn').classList.add('btn-warning');
          currentUtterance.onstart = ()=>{ showNotification('ğŸ”Š Ø¨Ø¯Ø£Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù„ÙŠØ©','success',2000); };
          currentUtterance.onend = ()=>{ stopAutoRead(); };
          currentUtterance.onerror = (e)=>{ showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª: '+e.error,'error',3000); stopAutoRead(); playFallback('error'); };
          if (syncWithAudio) startWordTracking();
          try { speechSynthesisRef.speak(currentUtterance); playFallback('start'); } catch(e){ showNotification('âŒ ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø·Ù‚','error'); stopAutoRead(); playFallback('error'); }
        },100);
      } else {
        // ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…: Ù†Ø¹Ù„Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ†Ø´ØºÙ„ ØµÙˆØªÙ‹Ø§ Ø§Ø­ØªÙŠØ§Ø·ÙŠÙ‹Ø§
        showNotification('âš ï¸ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù„ÙŠØ© (Web Speech API). Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø£ØµÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙ‚Ø·.','warning',5000);
        playFallback('start');
      }
    }

    function stopAutoRead(){
      isAutoReading = false;
      if (ttsSupported && currentUtterance){ speechSynthesisRef.cancel(); currentUtterance = null; }
      if (autoReadInterval){ clearInterval(autoReadInterval); autoReadInterval = null; }
      const btn = document.getElementById('autoReadBtn');
      btn.innerHTML = 'ğŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù„ÙŠØ©'; btn.classList.remove('btn-warning'); btn.classList.add('btn-success');
      playFallback('stop');
    }

    function updateReadingSpeed(){
      autoReadSpeed = parseFloat(document.getElementById('readingSpeedSelect').value);
      if (isAutoReading && ttsSupported && currentUtterance){ stopAutoRead(); setTimeout(()=>startAutoRead(),100); }
    }
    function updateCursorSpeed(){ cursorSpeed = parseFloat(document.getElementById('cursorSpeedRange').value); document.getElementById('cursorSpeedValue').textContent = cursorSpeed.toFixed(1)+'x'; }
    function toggleSyncWithAudio(){ syncWithAudio = document.getElementById('syncWithAudio').checked; }

    function startWordTracking(){
      if (!syncWithAudio) return;
      const wordsPerSecond = (autoReadSpeed*2.5)*cursorSpeed; const intervalTime = 1000/wordsPerSecond;
      autoReadInterval = setInterval(()=>{
        if (currentWordIndex < words.length-1 && isAutoReading){ currentWordIndex++; highlightCurrentWord(); updateProgress(); }
        else { clearInterval(autoReadInterval); autoReadInterval=null; }
      }, intervalTime);
    }

    // ====== Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©/Ø§Ù„Ø¹Ø¯Ø§Ø¯ ======
    function startReading(){
      if (words.length===0) return; isReading=true; isPaused=false; if (startTime===null){ startTime=Date.now(); } else { startTime = Date.now() - pausedTime; }
      document.getElementById('startBtn').disabled=true; document.getElementById('pauseBtn').disabled=false; document.getElementById('stopBtn').disabled=false;
      startTimer(); highlightCurrentWord(); playFallback('start');
    }

    function pauseReading(){ isReading=false; isPaused=true; pausedTime = Date.now()-startTime; document.getElementById('startBtn').disabled=false; document.getElementById('pauseBtn').disabled=true; clearInterval(timerInterval); playFallback('pause'); }

    function stopReading(){
      isReading=false; isPaused=false; const endTime = Date.now(); const totalTime = Math.floor((endTime-startTime)/1000); const wpm = Math.round((currentWordIndex/Math.max(totalTime,1))*60);
      saveSession(totalTime, currentWordIndex, wpm);
      document.getElementById('startBtn').disabled=false; document.getElementById('pauseBtn').disabled=true; document.getElementById('stopBtn').disabled=true; clearInterval(timerInterval);
      showResults(totalTime, currentWordIndex, wpm); playFallback('stop');
    }

    function resetAll(){ resetReading(); loadSelectedText(); }
    function resetReading(){ isReading=false; isPaused=false; startTime=null; pausedTime=0; currentWordIndex=0; if (isAutoReading) stopAutoRead(); document.getElementById('startBtn').disabled=false; document.getElementById('pauseBtn').disabled=true; document.getElementById('stopBtn').disabled=true; clearInterval(timerInterval); document.getElementById('timerDisplay').textContent='00:00'; document.getElementById('wordsRead').textContent='0'; document.getElementById('readingSpeed').textContent='0 Ùƒ/Ø¯'; document.getElementById('progressBar').style.width='0%'; document.getElementById('progressText').textContent='0%'; words.forEach((_,i)=>{ const el=document.getElementById(`word-${i}`); if(el) el.classList.remove('word-highlight'); }); }

    function startTimer(){
      timerInterval = setInterval(()=>{
        if (!isReading) return; const now=Date.now(); const elapsed=Math.floor((now-startTime)/1000); updateTimerDisplay(elapsed); updateStats(elapsed); updateProgress(); if (currentWordIndex < words.length-1){ currentWordIndex++; highlightCurrentWord(); } else { stopReading(); }
      },1000);
    }

    function updateTimerDisplay(seconds){ const m=Math.floor(seconds/60); const s=seconds%60; document.getElementById('timerDisplay').textContent=`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; const circumference=283; const progress=(seconds%60)/60; const offset=circumference-(progress*circumference); document.getElementById('timerCircle').style.strokeDashoffset=offset; }
    function updateStats(elapsed){ document.getElementById('wordsRead').textContent=currentWordIndex; if (elapsed>0){ const wpm=Math.round((currentWordIndex/elapsed)*60); document.getElementById('readingSpeed').textContent=wpm+' Ùƒ/Ø¯'; } }
    function updateProgress(){ const p=(currentWordIndex/words.length)*100; document.getElementById('progressBar').style.width=p+'%'; document.getElementById('progressText').textContent=Math.round(p)+'%'; }
    function highlightCurrentWord(){ if (currentWordIndex>0){ const prev=document.getElementById(`word-${currentWordIndex-1}`); if(prev) prev.classList.remove('word-highlight'); } const cur=document.getElementById(`word-${currentWordIndex}`); if(cur){ cur.classList.add('word-highlight'); cur.scrollIntoView({behavior:'smooth', block:'center'}); } }

    function saveSession(duration, wordsRead, wpm){ const progress=Math.round((wordsRead/words.length)*100); const session={ date:new Date().toLocaleDateString('ar-SA'), time:new Date().toLocaleTimeString('ar-SA'), text:texts[currentTextIndex].title, duration, wordsRead, wpm, progress }; sessions.unshift(session); if(sessions.length>10) sessions.pop(); updateSpeedChart(wpm); updateProgressChart(progress); updateSessionHistory(); }

    // ====== Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ ======
    async function startRecording(){
      try{
        audioStream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, sampleRate:44100, channelCount:2 } });
        const options = { mimeType:'audio/webm;codecs=opus', audioBitsPerSecond:128000 };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) options.mimeType='audio/webm';
        mediaRecorder = new MediaRecorder(audioStream, options);
        audioChunks = [];
        mediaRecorder.ondataavailable = e=>{ if(e.data.size>0) audioChunks.push(e.data); };
        mediaRecorder.onstop = ()=>{ const mimeType = mediaRecorder.mimeType || 'audio/webm'; const blob = new Blob(audioChunks,{type:mimeType}); saveAudioRecording(blob, mimeType); };
        mediaRecorder.start(1000); isRecording=true;
        document.getElementById('recordBtn').disabled=true; document.getElementById('stopRecordBtn').disabled=false; document.getElementById('recordBtn').classList.add('recording-pulse'); document.getElementById('recordingStatus').innerHTML='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ <span class="recording-indicator"></span>';
        startRecordingTimer(); playFallback('rec_start');
      }catch(err){ console.error(err); let msg='Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.'; if (err.name==='NotAllowedError') msg='ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.'; else if (err.name==='NotFoundError') msg='Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.'; alert(msg); playFallback('error'); }
    }

    function startRecordingTimer(){ recordingStartTime=Date.now(); recordingTimer=setInterval(()=>{ const elapsed=Math.floor((Date.now()-recordingStartTime)/1000); const m=Math.floor(elapsed/60); const s=elapsed%60; document.getElementById('recordingStatus').innerHTML=`Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')} <span class="recording-indicator"></span>`; },1000); }

    function stopRecording(){ if (mediaRecorder && isRecording){ mediaRecorder.stop(); audioStream.getTracks().forEach(t=>t.stop()); isRecording=false; if(recordingTimer){ clearInterval(recordingTimer); recordingTimer=null; } document.getElementById('recordBtn').disabled=false; document.getElementById('stopRecordBtn').disabled=true; document.getElementById('recordBtn').classList.remove('recording-pulse'); document.getElementById('recordingStatus').innerHTML='â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„...'; playFallback('rec_stop'); setTimeout(()=>{ document.getElementById('recordingStatus').textContent='Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„'; },3000); } }

    function saveAudioRecording(audioBlob, mimeType){ const audioUrl = URL.createObjectURL(audioBlob); const now = Date.now(); const dur = recordingStartTime ? Math.floor((now-recordingStartTime)/1000):0; let fileExtension='webm'; if (mimeType.includes('mp4')) fileExtension='mp4'; else if (mimeType.includes('wav')) fileExtension='wav'; else if (mimeType.includes('ogg')) fileExtension='ogg'; const recording={ id:Date.now(), date:new Date().toLocaleDateString('ar-SA'), time:new Date().toLocaleTimeString('ar-SA'), text:texts[currentTextIndex].title, audioUrl, audioBlob, mimeType, fileExtension, duration:dur, size: Math.round(audioBlob.size/1024), wordsRead: currentWordIndex, wpm: dur>0? Math.round((currentWordIndex/dur)*60):0, quality: audioBlob.size>100000?'Ø¹Ø§Ù„ÙŠØ©': audioBlob.size>50000?'Ù…ØªÙˆØ³Ø·Ø©':'Ù…Ù†Ø®ÙØ¶Ø©' };
      saveToIndexedDB(recording); downloadRecording(audioUrl, recording.text, recording.date, fileExtension); if(!window.audioRecordings) window.audioRecordings=[]; window.audioRecordings.unshift(recording); if(window.audioRecordings.length>20){ const old=window.audioRecordings.pop(); URL.revokeObjectURL(old.audioUrl); } updateAudioRecordings(); showNotification('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ!','success'); playFallback('saved'); }

    function updateAudioRecordings(){ const wrap=document.getElementById('audioRecordings'); const list=window.audioRecordings||[]; if (list.length===0){ wrap.innerHTML='<div class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª ØµÙˆØªÙŠØ© Ø¨Ø¹Ø¯</div>'; return; } wrap.innerHTML = list.map(r=>`<div class="bg-gradient-to-r from-blue-50 to-blue-100 p-3 rounded-lg border border-blue-200"><div class="flex justify-between items-start mb-2"><div class="text-sm font-bold text-gray-800">${r.text}</div><div class="text-xs text-gray-500">${r.date}</div></div><div class="mb-3"><audio controls class="w-full h-8"><source src="${r.audioUrl}" type="${r.mimeType}">Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª</audio></div><div class="grid grid-cols-2 gap-2 text-xs mb-2"><div><span class="text-gray-600">Ø§Ù„Ù…Ø¯Ø©:</span> <span class="font-bold">${Math.floor(r.duration/60)}:${(r.duration%60).toString().padStart(2,'0')}</span></div><div><span class="text-gray-600">Ø§Ù„Ø­Ø¬Ù…:</span> <span class="font-bold">${r.size} Ùƒ.Ø¨</span></div><div><span class="text-gray-600">Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</span> <span class="font-bold">${r.wordsRead||0}</span></div><div><span class="text-gray-600">Ø§Ù„Ø³Ø±Ø¹Ø©:</span> <span class="font-bold">${r.wpm||0} Ùƒ/Ø¯</span></div><div><span class="text-gray-600">Ø§Ù„Ø¬ÙˆØ¯Ø©:</span> <span class="font-bold">${r.quality||'Ù…ØªÙˆØ³Ø·Ø©'}</span></div><div><span class="text-gray-600">Ø§Ù„Ù†ÙˆØ¹:</span> <span class="font-bold">${(r.fileExtension||'webm').toUpperCase()}</span></div></div><div class="flex gap-2 flex-wrap"><button onclick="downloadRecording('${r.audioUrl}','${r.text}','${r.date}','${r.fileExtension||'webm'}')" class="btn-gradient text-white px-3 py-1 rounded text-xs">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button><button onclick="deleteRecording(${r.id})" class="btn-danger text-white px-3 py-1 rounded text-xs">ğŸ—‘ï¸ Ø­Ø°Ù</button><button onclick="shareRecording(${r.id})" class="btn-success text-white px-3 py-1 rounded text-xs">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button></div></div>`).join(''); }

    function downloadRecording(audioUrl, textTitle, date, ext='webm'){ const a=document.createElement('a'); a.href=audioUrl; const cleanTitle=textTitle.replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\w\s]/g,''); const cleanDate=date.replace(/[^\d-]/g,'-'); const ts=new Date().toISOString().slice(11,19).replace(/:/g,'-'); a.download=`ØªØ³Ø¬ÙŠÙ„_Ù‚Ø±Ø§Ø¡Ø©_${cleanTitle}_${cleanDate}_${ts}.${ext}`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

    async function deleteRecording(id){ if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ')){ const list=window.audioRecordings||[]; const idx=list.findIndex(r=>r.id===id); if(idx!==-1){ URL.revokeObjectURL(list[idx].audioUrl); list.splice(idx,1); try{ const db=await initIndexedDB(); const tx=db.transaction(['recordings'],'readwrite'); const store=tx.objectStore('recordings'); await store.delete(id); }catch(e){ console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„',e);} updateAudioRecordings(); } } }

    function shareRecording(id){ const r=(window.audioRecordings||[]).find(x=>x.id===id); if(!r) return; if (navigator.share && r.audioBlob){ navigator.share({ title:`ØªØ³Ø¬ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø© - ${r.text}`, text:`ØªØ³Ø¬ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø© Ù„Ù†Øµ "${r.text}" - Ø§Ù„Ù…Ø¯Ø©: ${Math.floor(r.duration/60)}:${(r.duration%60).toString().padStart(2,'0')} - Ø§Ù„Ø³Ø±Ø¹Ø©: ${r.wpm} ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©`, files:[new File([r.audioBlob], `ØªØ³Ø¬ÙŠÙ„_${r.text}_${r.date.replace(/\//g,'-')}.${r.fileExtension||'webm'}`, {type:r.mimeType})] }).catch(()=>fallbackShare(r)); } else { fallbackShare(r); } }

    function fallbackShare(r){ const txt=`ØªØ³Ø¬ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø© Ù„Ù†Øµ "${r.text}"\nØ§Ù„Ù…Ø¯Ø©: ${Math.floor(r.duration/60)}:${(r.duration%60).toString().padStart(2,'0')}\nØ§Ù„Ø³Ø±Ø¹Ø©: ${r.wpm} ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©\nØ§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: ${r.wordsRead}`; if (navigator.clipboard){ navigator.clipboard.writeText(txt).then(()=>alert('ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!')); } else { prompt('Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', txt); } }

    function updateSessionHistory(){ const box=document.getElementById('sessionHistory'); if (sessions.length===0){ box.innerHTML='<div class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</div>'; return; } box.innerHTML = sessions.map(s=>`<div class="bg-gradient-to-r from-gray-50 to-gray-100 p-3 rounded-lg border border-gray-200"><div class="flex justify-between items-start mb-2"><div class="text-sm font-bold text-gray-800">${s.text}</div><div class="text-xs text-gray-500">${s.date}</div></div><div class="grid grid-cols-2 gap-2 text-xs"><div><span class="text-gray-600">Ø§Ù„Ù…Ø¯Ø©:</span> <span class="font-bold">${Math.floor(s.duration/60)}:${(s.duration%60).toString().padStart(2,'0')}</span></div><div><span class="text-gray-600">Ø§Ù„Ø³Ø±Ø¹Ø©:</span> <span class="font-bold">${s.wpm} Ùƒ/Ø¯</span></div><div><span class="text-gray-600">Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</span> <span class="font-bold">${s.wordsRead}</span></div><div><span class="text-gray-600">Ø§Ù„ØªÙ‚Ø¯Ù…:</span> <span class="font-bold">${s.progress}%</span></div></div></div>`).join(''); }

    function showResults(duration, wordsRead, wpm){ const m=Math.floor(duration/60); const s=duration%60; const p=Math.round((wordsRead/words.length)*100); document.querySelector('.timer-container').classList.add('celebration'); setTimeout(()=>{ document.querySelector('.timer-container').classList.remove('celebration'); },600); alert(`ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£Ù†Ù‡ÙŠØª Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©\n\nâ±ï¸ Ø§Ù„Ù…Ø¯Ø©: ${m}:${s.toString().padStart(2,'0')}\nğŸ“– Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: ${wordsRead}\nğŸš€ Ø§Ù„Ø³Ø±Ø¹Ø©: ${wpm} ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©\nğŸ“Š Ø§Ù„ØªÙ‚Ø¯Ù…: ${p}%`); }

    // ====== Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª ======
    function initializeCharts(){ const speedCtx=document.getElementById('speedChart').getContext('2d'); const savedS=JSON.parse(localStorage.getItem('speedChartData')||'{"labels":[],"data":[]}'); speedChartData.labels=savedS.labels||[]; speedChartData.datasets[0].data=savedS.data||[]; speedChart=new Chart(speedCtx,{ type:'line', data:speedChartData, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true, labels:{ font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } } }, scales:{ y:{ beginAtZero:true, title:{ display:true, text:'ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©', font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } }, x:{ title:{ display:true, text:'Ø§Ù„Ø¬Ù„Ø³Ø§Øª', font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } } } } }); const progressCtx=document.getElementById('progressChart').getContext('2d'); const savedP=JSON.parse(localStorage.getItem('progressChartData')||'{"labels":[],"data":[]}'); progressChartData.labels=savedP.labels||[]; progressChartData.datasets[0].data=savedP.data||[]; progressChart=new Chart(progressCtx,{ type:'bar', data:progressChartData, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true, labels:{ font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } } }, scales:{ y:{ beginAtZero:true, max:100, title:{ display:true, text:'Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù… (%)', font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } }, x:{ title:{ display:true, text:'Ø§Ù„Ø¬Ù„Ø³Ø§Øª', font:{ family:'Cairo, Tajawal, sans-serif', size:12 } } } } } }); }

    function updateSpeedChart(wpm){ const n=speedChartData.labels.length+1; speedChartData.labels.push(`Ø¬Ù„Ø³Ø© ${n}`); speedChartData.datasets[0].data.push(wpm); if (speedChartData.labels.length>15){ speedChartData.labels.shift(); speedChartData.datasets[0].data.shift(); } speedChart.update(); localStorage.setItem('speedChartData', JSON.stringify({ labels:speedChartData.labels, data:speedChartData.datasets[0].data })); }
    function updateProgressChart(p){ const n=progressChartData.labels.length+1; progressChartData.labels.push(`Ø¬Ù„Ø³Ø© ${n}`); progressChartData.datasets[0].data.push(p); if (progressChartData.labels.length>15){ progressChartData.labels.shift(); progressChartData.datasets[0].data.shift(); } progressChart.update(); localStorage.setItem('progressChartData', JSON.stringify({ labels:progressChartData.labels, data:progressChartData.datasets[0].data })); }
    function clearSpeedChartData(){ if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø·Ø· Ø§Ù„Ø³Ø±Ø¹Ø©ØŸ')){ speedChartData.labels=[]; speedChartData.datasets[0].data=[]; speedChart.update(); localStorage.removeItem('speedChartData'); } }
    function clearProgressChartData(){ if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø·Ø· Ø§Ù„ØªÙ‚Ø¯Ù…ØŸ')){ progressChartData.labels=[]; progressChartData.datasets[0].data=[]; progressChart.update(); localStorage.removeItem('progressChartData'); } }

    // ====== IndexedDB ======
    function initIndexedDB(){ return new Promise((resolve,reject)=>{ const req=indexedDB.open('ReadingRecordings',1); req.onerror=()=>reject(req.error); req.onsuccess=()=>resolve(req.result); req.onupgradeneeded=(e)=>{ const db=e.target.result; if(!db.objectStoreNames.contains('recordings')){ const store=db.createObjectStore('recordings',{keyPath:'id'}); store.createIndex('date','date',{unique:false}); } }; }); }
    async function saveToIndexedDB(recording){ try{ const db=await initIndexedDB(); const tx=db.transaction(['recordings'],'readwrite'); const store=tx.objectStore('recordings'); const arrayBuffer = await recording.audioBlob.arrayBuffer(); const obj={ ...recording, audioData: arrayBuffer, audioBlob:null, audioUrl:null }; await store.add(obj); }catch(e){ console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', e); } }
    async function loadFromIndexedDB(){ try{ const db=await initIndexedDB(); const tx=db.transaction(['recordings'],'readonly'); const store=tx.objectStore('recordings'); const req=store.getAll(); return new Promise((res,rej)=>{ req.onsuccess=()=>{ const list=req.result.map(r=>{ const blob=new Blob([r.audioData],{type:'audio/wav'}); const url=URL.createObjectURL(blob); return { ...r, audioBlob:blob, audioUrl:url, mimeType:'audio/wav' }; }); res(list); }; req.onerror=()=>rej(req.error); }); }catch(e){ console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª:', e); return []; } }

    // ====== Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ======
    function showNotification(message, type='info', duration=4000){ const container=document.getElementById('notificationContainer'); const div=document.createElement('div'); const bg = type==='success'?'bg-green-500': type==='error'?'bg-red-500': type==='warning'?'bg-yellow-500':'bg-blue-500'; div.className=`${bg} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 max-w-sm`;
      div.innerHTML=`<div class='flex items-center justify-between'><span class='font-medium'>${message}</span><button onclick='this.parentElement.parentElement.remove()' class='ml-3 text-white hover:text-gray-200'>âœ•</button></div>`; container.appendChild(div); setTimeout(()=>{ div.classList.remove('translate-x-full'); },100); setTimeout(()=>{ div.classList.add('translate-x-full'); setTimeout(()=>{ if(div.parentElement){ div.remove(); } },300); },duration); }

    // ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª (Web Speech API) ======
    function loadVoices(){ return new Promise((resolve)=>{ if(!ttsSupported){ resolve([]); return; } let voices = speechSynthesisRef.getVoices(); if (voices.length>0){ resolve(voices); } else { speechSynthesisRef.onvoiceschanged = ()=>{ voices = speechSynthesisRef.getVoices(); resolve(voices); }; setTimeout(()=>{ voices = speechSynthesisRef.getVoices(); resolve(voices); },1000); } }); }

    async function showAvailableVoices(){ const voices = await loadVoices(); availableVoices = voices; const arabicVoices = voices.filter(v=> v.lang?.includes('ar') || v.name?.includes('Arabic') || v.name?.includes('Ø¹Ø±Ø¨ÙŠ')); updateVoiceSelect(voices, arabicVoices); if (arabicVoices.length>0){ showNotification(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${arabicVoices.length} ØµÙˆØª Ø¹Ø±Ø¨ÙŠ`,'success',3000); selectedVoice = arabicVoices[0]; } else { showNotification('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ØµÙˆØ§Øª Ø¹Ø±Ø¨ÙŠØ© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ â€” Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø£Ùˆ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©','warning',5000); }
    }

    function updateVoiceSelect(allVoices, arabicVoices){ const sel=document.getElementById('voiceSelect'); sel.innerHTML=''; const def=document.createElement('option'); def.value=''; def.textContent='Ø§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ'; sel.appendChild(def); if (arabicVoices.length>0){ const group=document.createElement('optgroup'); group.label='Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'; arabicVoices.forEach((v,i)=>{ const o=document.createElement('option'); o.value=i+'_arabic'; o.textContent=`${v.name} (${v.lang})`; if(i===0) o.selected=true; group.appendChild(o); }); sel.appendChild(group); }
      const others = allVoices.filter(v=> !v.lang?.includes('ar') && !v.name?.includes('Arabic') && !v.name?.includes('Ø¹Ø±Ø¨ÙŠ'));
      if (others.length>0){ const g=document.createElement('optgroup'); g.label='Ø£ØµÙˆØ§Øª Ø£Ø®Ø±Ù‰'; others.forEach((v,i)=>{ const o=document.createElement('option'); o.value=(i+arabicVoices.length)+'_other'; o.textContent=`${v.name} (${v.lang})`; g.appendChild(o); }); sel.appendChild(g); }
    }

    function updateSelectedVoice(){ const sel=document.getElementById('voiceSelect'); const val=sel.value; if(!val){ selectedVoice=null; return; } const [idxStr,type]=val.split('_'); const idx=parseInt(idxStr); const arabic = availableVoices.filter(v=> v.lang?.includes('ar') || v.name?.includes('Arabic') || v.name?.includes('Ø¹Ø±Ø¨ÙŠ')); if (type==='arabic'){ selectedVoice = arabic[idx]; } else { const others = availableVoices.filter(v=> !v.lang?.includes('ar') && !v.name?.includes('Arabic') && !v.name?.includes('Ø¹Ø±Ø¨ÙŠ')); selectedVoice = others[idx]; }
    }

    function testVoice(){ if (isAutoReading){ showNotification('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹','warning'); return; } const t='Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØµÙˆØª Ø§Ù„Ù…Ø­Ø¯Ø¯'; if (ttsSupported){ const u=new SpeechSynthesisUtterance(t); u.lang='ar-SA'; u.rate=autoReadSpeed; if (selectedVoice) u.voice=selectedVoice; u.onstart=()=>showNotification('ğŸµ Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª...','info',2000); u.onend=()=>showNotification('âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª','success',2000); u.onerror=()=>{ showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª','error'); playFallback('error'); }; speechSynthesisRef.speak(u); } else { playFallback('start'); showNotification('ğŸ”‰ ØªÙ… ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªØ¬Ø±ÙŠØ¨ÙŠ Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø¹Ù… TTS Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ).','info',4000); } }

    // ====== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      loadSelectedText(); initializeCharts(); window.audioRecordings = await loadFromIndexedDB(); updateAudioRecordings(); await showAvailableVoices(); setTimeout(()=>{ showNotification('ğŸ™ï¸ Ø¬Ø§Ù‡Ø²: ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù„ÙŠØ© Ø£Ùˆ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª','info',6000); }, 1200);
      document.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); if(!isReading && !isPaused){ startReading(); } else if (isReading){ pauseReading(); } else if (isPaused){ startReading(); } } else if (e.code==='Escape'){ stopReading(); } else if (e.code==='KeyR' && e.ctrlKey){ e.preventDefault(); if(!isRecording){ startRecording(); } else { stopRecording(); } } else if (e.code==='KeyA' && e.ctrlKey){ e.preventDefault(); toggleAutoRead(); } });
    });
  </script>
</body>
</html>
